---
title: "Simulation of log fitness change"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```

# DATA
## Load data
```{r }
## Longitudinal data
data_sum <- loadlongitudinaldata(dataset = "DATA_Adults_G1G29.csv", rm_generation1 = 1,rm_generation2 = 7,rm_generation3 = 29)


## Phenotyping steps
data_G0 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G1")
data_G7 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G7")
data_G29 <- loadfitnessdata(dataset = 
                            "PERFORMANCE_Comptage_adultes_G13G14G15G16G17G18G19G20G21G22G23G24G25G26G27G28G29.csv",
                            generation = "29")
head(data_sum)
head(data_G0)
head(data_G7)
head(data_G29)
dim(data_G29)

## Add line variable
levels(data_G0$Line) <- rep("Anc", nlevels(data_G0$Line))

## Combine datsets
data <- rbind(data_G0, data_G7, data_G29) 
data <- data.frame(Generation = c(rep("0", nrow(data_G0)), rep("7", nrow(data_G7)), rep("29", nrow(data_G29))), data, Obs= as.factor(1:nrow(data)))
head(data)

## New variable for analyses
data$Generation_Fruit_s_Treatment <- as.factor(paste(data$Generation, data$Fruit_s, data$Treatment, sep="_"))
data$Line_Treatment <- as.factor(paste(data$Line, data$Treatment, sep="_"))
data$Treatmentrel <- relevel(data$Treatment, ref="Strawberry")
```


## Compute fitess change per population
```{r }

mfitness <- MASS::glm.nb(Nb_adults ~ Treatment, data=data)
summary(mfitness)

pr1 <- profile(mfitness, alpha = 0.1)

MASS:::plot.profile(pr1)



### Fitness
mfitness <- MASS::glm.nb(Nb_adults ~ -1 + Treatment + Line:Treatment, data=data)
summary(mfitness)

CIfitness <- confint(mfitness)

pr1 <- profile(mfitness, alpha = 0.1)

# pdf(file="figures/Profile.pdf")
# MASS:::plot.profile(pr1)
# dev.off()



### 
### Fecundity
### 
mfecundity <- MASS::glm.nb(Nb_eggs ~ -1+Treatment+Line:Treatment, data=data)
summary(mfecundity)

CIfecundity <- confint(mfecundity)

### 
### Egg-to-adult viability
### 
## 4 tubes with more adults than eggs
sum(data$Nb_adults>data$Nb_eggs)
## Number of adults=number of eggs
data$Nb_eggs[data$Nb_adults>data$Nb_eggs] <- data$Nb_adults[data$Nb_adults>data$Nb_eggs]

## Fit model
megg_to_ad <- glm(cbind(Nb_adults, Nb_eggs) ~ -1+Treatment+Line:Treatment, data=data, family="binomial")
summary(megg_to_ad)

CImegg_to_ad <- confint(megg_to_ad)

####### 
####### Build data_logchange dataset
####### 
## Extract all CIs
## Check that the coef are in the same order
identical(names(coef(mfitness)), names(coef(mfecundity)))
identical(names(coef(mfitness)), names(coef(megg_to_ad)))

data_logchange <- data.frame(logchange=coef(mfitness),
                             lowCIlogfitnesschange=CIfitness[, 1],
                             upCIlogfitnesschange=CIfitness[, 2],
                             logfecundchange=coef(mfecundity),
                             lowCIlogfecundchange=CIfecundity[, 1],
                             upCIlogfecundchange=CIfecundity[, 2],
                             logeggtoadchange=coef(megg_to_ad),
                             lowCIlogeggtoadchange=CImegg_to_ad[, 1],
                             upCIlogeggtoadchange=CImegg_to_ad[, 2])
head(data_logchange)

## Remove estimates from ancestral population
data_logchange <- data_logchange[4:nrow(data_logchange), ]
  
## Extract information regarding line, selective and test media
rowname <- strsplit(rownames(data_logchange), split=":")
Treatment <- as.factor(gsub("Treatment", "", lapply(rowname, `[[`, 1)))
Generation <- Line <- as.factor(gsub("Line", "", lapply(rowname, `[[`, 2)))
## Change Fruit_s levels
Fruit_s <- as.factor(substr(Line, 1, 2))
levels(Fruit_s) <- levels(Treatment)
## Change levels
levels(Generation) <- ifelse(is.na(as.numeric(substr(levels(Generation), 3, 3))), "29", "7")

## Combine data
data_info <- data.frame(Treatment, Line, Fruit_s, Generation)
data_info$Line_Treatement <- paste(data_info$Line, data_info$Treatment, sep="_")
# Add symp and allop
data_info$SA <- as.factor(ifelse(data_info$Treatment == data_info$Fruit_s , 1, 0))
data.frame(names(coef(mfitness))[4:length(coef(mfitness))], data_info)

## Compute sample size per line and test medium
sample_size <- aggregate(Nb_eggs~Line:Treatment, length, data=data[data$Generation!="0",])
sample_size$Line_Treatement <- paste(sample_size$Line, sample_size$Treatment, sep="_")
names(sample_size)[3] <- "N"

## Merge the three datasets
data_info <- merge(x=data_info, y=sample_size[, 3:4], by="Line_Treatement")
data_info$Line_Treatment <- paste0("Treatment", data_info$Treatment, ":Line", data_info$Line)
data_logchange$Line_Treatment <- rownames(data_logchange)
data_logchange <- merge(x=data_info, y=data_logchange, by = "Line_Treatment")[, -c(1, 2)]

head(data_logchange)
```

## Formatting dataset 
```{r }
#Formatting for plotting pairwise of fitness change
EC_Cran_Cher_G7<-formattingplotpair(data_logchange, "7", "Cherry", "Cranberry")
EC_Straw_Cran_G7<-formattingplotpair(data_logchange, "7", "Cranberry", "Strawberry")
EC_Straw_Cher_G7<-formattingplotpair(data_logchange, "7", "Strawberry", "Cherry")
EC_Cran_Cher_G29<-formattingplotpair(data_logchange, "29", "Cherry", "Cranberry")
EC_Straw_Cran_G29<-formattingplotpair(data_logchange, "29", "Cranberry", "Strawberry")
EC_Straw_Cher_G29<-formattingplotpair(data_logchange, "29", "Strawberry", "Cherry")


#Formatting for plot pool
TEMP_dataG29_CheCran <- formattinglogchange(data_logchange, "29", fruitcomb=c("Cherry", "Cranberry"), trait="fitness")
TEMP_dataG29_CranStraw <- formattinglogchange(data_logchange, "29", fruitcomb=c("Cranberry", "Strawberry"), trait="fitness")
TEMP_dataG29_StrawChe <- formattinglogchange(data_logchange, "29", fruitcomb=c("Strawberry", "Cherry"), trait="fitness")


## Data longitudinal 
data_sum_allfruits <- loadlongitudinaldata_allfruits(dataset = "DATA_Adults_G1G29.csv", rm_generation_max = 5)
data_sum_allfruits_AN<-data_sum_allfruits[data_sum_allfruits$Generation!=1,]
```





# SUP: Pairwise fitness change
## Plot 
```{r } 
#Limit axis 
lim_G7<-max(abs(min(data_logchange[data_logchange$Generation=="7",]$lowCIlogfitnesschange, na.rm = T)),
            max(data_logchange[data_logchange$Generation=="7",]$upCIlogfitnesschange, na.rm = T))

lim_G29<-max(abs(min(data_logchange[data_logchange$Generation=="29",]$upCIlogfitnesschange, na.rm = T)),
            max(data_logchange[data_logchange$Generation=="29",]$upCIlogfitnesschange, na.rm = T))

#Plot
PAIR_StrawCran_G7<-ggplot(data = EC_Straw_Cran_G7,
                          aes(x = logchange_Strawberry,y = logchange_Cranberry, color=Fruit_s)) +
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Cranberry,
                    ymax = upCIlogfitnesschange_Cranberry),
                width=0.02,size=0.2,alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Strawberry,
                     xmax = upCIlogfitnesschange_Cranberry),
                 height=0.02,size=0.2,alpha=1) + 
  geom_point(shape=21, size=3,  fill = "#ffffff", stroke=1.3) + 
  xlab("Fitness change\nin strawberry")  +     
  ylab("Fitness change\nin cranberry")  +
  xlim(-lim_G7,lim_G7) + 
  ylim(-lim_G7,lim_G7) +  
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme(axis.title.x = element_text(size=10, colour = "#3FAA96"),
        axis.title.y = element_text(size=10, colour = "#FDB424")) +
  theme_LO_sober
 PAIR_StrawCran_G7

 
 
PAIR_StrawChe_G7<-ggplot(data = EC_Straw_Cher_G7,
                         aes(x = logchange_Cherry,y = logchange_Strawberry, color=Fruit_s)) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Strawberry,
                    ymax = upCIlogfitnesschange_Strawberry),
                  width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Cherry,
                     xmax = upCIlogfitnesschange_Cherry),
                  height=0.02, size=0.2, alpha=1) + 
  geom_point(shape=21, size=3,  fill = "#ffffff", stroke=1.3) + 
  ylab("Fitness change\nin strawberry")  + 
  xlab("Fitness change\nin cherry")  + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  xlim(-lim_G7,lim_G7) + 
  ylim(-lim_G7,lim_G7) +    
  theme(axis.title.x = element_text(size=10, colour = "#BC3C6D"),
           axis.title.y = element_text(size=10, colour = "#3FAA96")) +
  theme_LO_sober
 PAIR_StrawChe_G7



 
PAIR_CheCran_G7<-ggplot(data = EC_Cran_Cher_G7,aes(x = logchange_Cranberry,y = logchange_Cherry, 
                                          color=Fruit_s)) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Cherry,
                      ymax = upCIlogfitnesschange_Cherry),
                  width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Cranberry,
                       xmax = upCIlogfitnesschange_Cranberry),
                  height=0.02, size=0.2, alpha=1) + 
  geom_point(shape=21, size=3,  fill = "#ffffff", stroke=1.3) + 
  ylab("Fitness change\nin cherry")  + 
  xlab("Fitness change\nin cranberry")  + 
  xlim(-lim_G7, lim_G7) + 
  ylim(-lim_G7, lim_G7) +     
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober + 
  theme(axis.title.x = element_text(colour = "#FDB424"),
        axis.title.y = element_text(colour = "#BC3C6D")) 
 PAIR_CheCran_G7



################## Final phenotyping step
#Plot
PAIR_CranStraw_G29<-ggplot(data = EC_Straw_Cran_G29,
                          aes(x = logchange_Strawberry, y = logchange_Cranberry,  color=Fruit_s)) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Cranberry,
                      ymax = upCIlogfitnesschange_Cranberry),
                  width=0.02,size=0.2,alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Strawberry,
                       xmax = upCIlogfitnesschange_Strawberry),
                  height=0.02,size=0.2,alpha=1) + 
  geom_point(aes(fill = Fruit_s),shape=21, size=3) + 
  xlab("Fitness change\nin strawberry")  +     
  ylab("Fitness change\nin cranberry")  +
  xlim(-lim_G29,lim_G29) + 
  ylim(-lim_G29,lim_G29) +     
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  scale_fill_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme(axis.title.x = element_text(size=10, colour = "#3FAA96"),
        axis.title.y = element_text(size=10, colour = "#FDB424")) +
  theme_LO_sober
 PAIR_CranStraw_G29

 
 
PAIR_StrawChe_G29<-ggplot(data = EC_Straw_Cher_G29,
                         aes(x = logchange_Cherry,y = logchange_Strawberry,  color=Fruit_s)) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Strawberry,
                      ymax = upCIlogfitnesschange_Strawberry),
                  width=0.02,size=0.2,alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Cherry,
                       xmax = upCIlogfitnesschange_Cherry),
                  height=0.02,size=0.2,alpha=1) + 
  geom_point(aes(fill = Fruit_s),shape=21, size=3) + 
  ylab("Fitness change\nin strawberry")  + 
  xlab("Fitness change\nin cherry")  + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  scale_fill_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  xlim(-lim_G29,lim_G29) + 
  ylim(-lim_G29,lim_G29) +       
  theme(axis.title.x = element_text(colour = "#BC3C6D"),
           axis.title.y = element_text(colour = "#3FAA96")) +
  theme_LO_sober
 PAIR_StrawChe_G29


 
PAIR_CheCran_G29<-ggplot(data = EC_Cran_Cher_G29,
                         aes(x = logchange_Cranberry,y = logchange_Cherry, color=Fruit_s)) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange_Cherry,
                      ymax = upCIlogfitnesschange_Cherry),
                  width=0.02,size=0.2,alpha=1) + 
  geom_errorbarh(aes(xmin = lowCIlogfitnesschange_Cranberry,
                       xmax = upCIlogfitnesschange_Cranberry),
                  height=0.02,size=0.2,alpha=1) + 
  geom_point(aes(fill = Fruit_s), shape=21, size=3) + 
  ylab("Fitness change\nin cherry")  + 
  xlab("Fitness change\nin cranberry")  + 
  xlim(-lim_G29,lim_G29) + 
  ylim(-lim_G29,lim_G29) +   
  scale_fill_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober + 
  theme(axis.title.x = element_text(colour = "#FDB424"),
        axis.title.y = element_text(colour = "#BC3C6D")) 
 PAIR_CheCran_G29


 #Legend
TEMP_data_logchange_sum_Straw_Cher_G7<-data_logchange
TEMP_data_logchange_sum_Straw_Cher_G7$Pheno<-sample(c("Intermediate", "Final"),
                                                    length(data_logchange$logchange), 
                                                    replace=TRUE)

PAIR_plot_legend<- ggplot(data=TEMP_data_logchange_sum_Straw_Cher_G7, 
                          aes(x=Treatment, y=logchange, group=Fruit_s, colour=Fruit_s,shape=Pheno)) +
  geom_errorbar(aes(ymin=lowCIlogfitnesschange, ymax=upCIlogfitnesschange),
                  width=0.01,size=1) +
  geom_point(size=3, stroke=1.3) + 
  scale_shape_manual(name = "Phenotyping step", 
                     labels = c("Intermediate", "Final"),values=c(21,16)) +
  scale_color_manual(name= "Selection fruit", 
                     values=c("#BC3C6D", "#FDB424", "#3FAA96"), 
                     label=c("Cherry", "Cranberry", "Strawberry")) +   
  theme_LO_sober
PAIR_legend<-lemon::g_legend(PAIR_plot_legend)

rm(TEMP_data_logchange_sum_Straw_Cher_G7)




PAIR_Fig_Sup <-  cowplot::ggdraw() +
  cowplot::draw_plot(PAIR_CheCran_G7+theme(legend.position = "none"), 
            x =0.00, y = 0.5, width = 0.22, height =0.45) +
  cowplot::draw_plot(PAIR_StrawCran_G7+theme(legend.position = "none"), 
            x = 0.26, y = 0.5, width = 0.22, height = 0.45) +
  cowplot::draw_plot(PAIR_StrawChe_G7+theme(legend.position = "none"), 
            x = 0.52, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(PAIR_legend, x = 0.80, y = 0.5, width = 0.1, height = 0.1) +
  cowplot::draw_plot(PAIR_CheCran_G29+theme(legend.position = "none"), 
            x =0.00, y = 0, width = 0.22, height = 0.45) +
  cowplot::draw_plot(PAIR_CranStraw_G29+theme(legend.position = "none"), 
            x = 0.26, y = 0, width = 0.22, height = 0.45) +
  cowplot::draw_plot(PAIR_StrawChe_G29+theme(legend.position = "none"), 
            x = 0.52, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", "B", "C", " ",
                    "Final phenotyping step", "D", "E", "F", " "),  
                  x = c(0.26,0,0.26,0.52,0.82,0.2,0,0.26,0.52,0.82), 
                  y = c(1.01,0.97,0.97,0.97,0.97,0.5,0.47, 0.47, 0.47, 0.47), 
                  hjust = c(-0.25,-0.25,-0.25,-0.25,-0.25,-0.75,-0.75,-0.75,-0.75,-0.75), 
                  vjust = c(1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5),
                  size = 14) 
 PAIR_Fig_Sup
 

cowplot::save_plot(file=here::here("figures", "SUPMAT_LogChange_Pairwise.pdf"), PAIR_Fig_Sup, 
                   base_height = 15/cm(1), base_width = 30/cm(1), dpi = 610)


```

# SUP: Correlation between Nb_eggs and emergence_rate
## Correlation
```{r }
tapply(data_G0$Nb_eggs, data_G0$Treatment, mean)
diag(tapply(data_G7$Nb_eggs, list(data_G7$Treatment,data_G7$Fruit_s), mean))
diag(tapply(data_G29$Nb_eggs, list(data_G29$Treatment,data_G29$Fruit_s), mean))


tapply(data_G0$Emergence_rate, data_G0$Treatment, mean)
diag(tapply(data_G7$Emergence_rate, list(data_G7$Treatment,data_G7$Fruit_s), mean))
diag(tapply(data_G29$Emergence_rate, list(data_G29$Treatment,data_G29$Fruit_s), mean))

## Compute correlation by generation and selective fruit
data_logchangeNb_eggsEmergence_rate<-data.frame(data_logchange[,c(1:6)],
                                                Nb_eggslogchange=data_logchange[,"logfecundchange"],
                                                Emergence_ratelogchange=data_logchange[,"logeggtoadchange"])
                                                
# plyr::ddply(data_logchangeNb_eggsEmergence_rate, .(Generation, Fruit_s), computecorrelation)
## WARNINGS: What is data_logchangeNb_eggsEmergence_rate?
#?????????
```






## Plot  
```{r } 
#Formating data
ymin = -50
ymax = 50

##################################################
##################   G7
# Plot
PAIR_Che_G7 <- ggplot(data = data_logchange[data_logchange$Generation=="7"&
                                             data_logchange$Fruit_s=="Cherry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change between\nintermediate and initial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability\nchange between intermediate\nand initial phenotyping steps")  + 
  ggtitle("Evolved on Cherry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#BC3C6D")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#BC3C6D"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"7","Cherry"), 
                  xlim = vec_minmax(data_logchange,"7","Cherry")) 
  
 PAIR_Che_G7


# Limits
PAIR_Cran_G7 <- ggplot(data = data_logchange[data_logchange$Generation=="7"&
                                             data_logchange$Fruit_s=="Cranberry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change between\nintermediate and initial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability change between\nintermediate and initial phenotyping steps")  + 
  ggtitle("Evolved on Cranberry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#FDB424")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#FDB424"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"7","Cranberry"), 
                  xlim = vec_minmax(data_logchange,"7","Cranberry")) 
  
 PAIR_Cran_G7

 
# Limits
# Limits
PAIR_Straw_G7 <- ggplot(data = data_logchange[data_logchange$Generation=="7"&
                                             data_logchange$Fruit_s=="Strawberry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change between\nintermediate and initial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability change between\nintermediate and initial phenotyping steps")  + 
  ggtitle("Evolved on Strawberry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#3FAA96")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#3FAA96"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"7","Strawberry"), 
                  xlim = vec_minmax(data_logchange,"7","Strawberry")) 
  
 PAIR_Straw_G7

  
#####################################################################################
##################################      G29        ##################################
#####################################################################################
# Plot
PAIR_Che_G29 <- ggplot(data = data_logchange[data_logchange$Generation=="29"&
                                             data_logchange$Fruit_s=="Cherry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change\nbetween final and\ninitial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability\nchange between final and\ninitial phenotyping steps")  + 
  ggtitle("Evolved on Cherry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#BC3C6D")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#BC3C6D"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"29","Cherry"), 
                  xlim = vec_minmax(data_logchange,"29","Cherry")) 
  
 PAIR_Che_G29


# Limits
PAIR_Cran_G29 <- ggplot(data = data_logchange[data_logchange$Generation=="29"&
                                             data_logchange$Fruit_s=="Cranberry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change between\nfinal and initial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability change between\nfinal and initial phenotyping steps")  + 
  ggtitle("Evolved on Cranberry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#FDB424")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#FDB424"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"29","Cranberry"), 
                  xlim = vec_minmax(data_logchange,"29","Cranberry")) 
  
 PAIR_Cran_G29

 
# Limits
# Limits
PAIR_Straw_G29 <- ggplot(data = data_logchange[data_logchange$Generation=="29"&
                                             data_logchange$Fruit_s=="Strawberry",]) + 
  geom_errorbar(aes(x = logfecundchange, 
                    ymin = lowCIlogeggtoadchange,
                    ymax = upCIlogeggtoadchange,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange, 
                     xmin = lowCIlogfecundchange, 
                     xmax = upCIlogfecundchange, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange, y = logeggtoadchange,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change between\nfinal and initial phenotyping steps")  + 
  ylab("Logit egg-to-adult viability change between\nfinal and initial phenotyping steps")  + 
  ggtitle("Evolved on Strawberry") + 
  theme_LO_sober + theme(plot.title = element_text(color = "#3FAA96")) +
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#3FAA96"))  + 
  coord_cartesian(ylim = vec_minmax(data_logchange,"29","Strawberry"), 
                  xlim = vec_minmax(data_logchange,"29","Strawberry")) 
  
 PAIR_Straw_G29


 
legend_tradevide <-  ggplot(data = data_logchange[data_logchange$Generation == "29",],
                          aes(x =logchange, y = logchange, fill = Fruit_s, 
                              shape = Treatment)) + 
  geom_point(size =2.5, fill = "white") + 
  labs(shape = "Test fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  theme_LO_sober

legend_trade <- lemon::g_legend(legend_tradevide)

 
 

CORRELATION_BETWEEN_TRAITS <- cowplot::ggdraw() + 
  cowplot::draw_plot(PAIR_Che_G7 + theme(legend.position = "none",
                                         axis.title.y = element_text(size=12),
                                         axis.title.x = element_blank()), 
            x = 0.01, y = 0.53, width = 0.3, height = 0.41) + 
  cowplot::draw_plot(PAIR_Cran_G7 + theme(legend.position = "none",   
                                         axis.title.x = element_blank(),
                                         axis.title.y = element_blank()), 
            x = 0.34, y = 0.53, width = 0.26, height = 0.41) + 
  cowplot::draw_plot(PAIR_Straw_G7+ theme(legend.position = "none", 
                                         axis.title.x = element_blank(), 
                                         axis.title.y = element_blank()), 
            x = 0.61, y = 0.53, width = 0.26, height = 0.41) + 
  cowplot::draw_plot(legend_trade, x = 0.89, y = 0.5, width = 0.1, height = 0.1) + 
  cowplot::draw_plot(PAIR_Che_G29 + theme(legend.position = "none",
                                         axis.title.y = element_text(size=12), 
                                         axis.title.x = element_blank()), 
            x = 0.01, y = 0.03, width = 0.3, height = 0.41) + 
  cowplot::draw_plot(PAIR_Cran_G29 + theme(legend.position = "none", 
                                         axis.title.x = element_blank(),
                                         axis.title.y = element_blank()), 
            x = 0.34, y = 00.03, width = 0.26, height = 0.41) + 
  cowplot::draw_plot(PAIR_Straw_G29 + theme(legend.position = "none", 
                                         axis.title.x = element_blank(), 
                                         axis.title.y = element_blank()), 
            x = 0.61, y = 00.03, width = 0.26, height = 0.41) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", " ", " ", " ",
                    "Final phenotyping step", "B", " ", " ", " ", 
                    "Log fecundity change between final and initial phenotyping steps", 
                    "Log fecundity change between intermediate and initial phenotyping steps"),  
                  x = c(0.28, 0.01, 0.34, 0.61, 0.92, 0.230, 0.01, 0.30, 0.61, 0.92,0.15,0.1), 
                  y = c(0.99, 0.95, 0.95, 0.95, 0.95, 0.49, 0.45, 0.45, 0.45, 0.45, 0.05, 0.55), 
                  hjust = c(-0.25, -0.25, -0.25, -0.25, -0.25, -0.75, -0.75, -0.75, -0.75, -0.75, -0.25,  -0.25), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = c(rep(16,10),12.5,12.5), 
                  fontface = c(rep("bold",10),"plain","plain")) 
 CORRELATION_BETWEEN_TRAITS
#  
# #  
# 
cowplot::save_plot(file =here::here("figures", "SUPMAT_Correlation_between_Traits.pdf"),
                   CORRELATION_BETWEEN_TRAITS,
                   base_height = 16/cm(1), base_width = 26/cm(1), dpi = 610)




```



# A SUPR: Long vs Fitness
## A SUPR
```{r eval=FALSE}
#To consider fruit maternal effect and GF maternal effect: new plot 
## Y-axis = log change = log(Fitness pheno)-log(fitness initial)
## X-axis = fitness temp / fitness initial
 ## example: for CEA during first phase 
    ## log(mean (CE1 from G2 to G5) / mean (Cherry G2))

##To check with Nico: for x-axis: denominator=mean Cherry G2 or mean CE1 G2 (???????????)


####### Phenotyping steps 
#Remove allopatric data
data_fitness_pheno <- data_logchange[data_logchange$SA==1,]
data_fitness_pheno <- data_fitness_pheno[, c("Line", "Fruit_s", "logchange", "lowCIlogfitnesschange", "upCIlogfitnesschange")]


####### Longitudinal data 
#Compute log change
data_logchange_long <- computelogchange_forlongdata(longitudinal_dataset = data_sum)


####### Merge data
data_compare_longitudinal_pheno <- merge(data_logchange_long,data_fitness_pheno,by=c("Line", "Fruit_s"))
data_compare_longitudinal_pheno <- droplevels(data_compare_longitudinal_pheno)

## Does not seem to be a correlation between measures
cor.test(data_compare_longitudinal_pheno$logchange[data_compare_longitudinal_pheno$Phase=="first_prepool"], data_compare_longitudinal_pheno$logchange_long[data_compare_longitudinal_pheno$Phase=="first_prepool"])

cor.test(data_compare_longitudinal_pheno$logchange[data_compare_longitudinal_pheno$Phase=="second_postpool"], data_compare_longitudinal_pheno$logchange_long[data_compare_longitudinal_pheno$Phase=="second_postpool"])


####### Geary test
#Lines: CE2 and CR2 do not pass Geary's test (the threshold of a standardized mean greater than 3)
data_compare_longitudinal_pheno$Line_type  <- ifelse(data_compare_longitudinal_pheno$Line == "CR2"|
                                                       data_compare_longitudinal_pheno$Line == "CE2", "solid","dashed")

```


## A SUPR Plot long vs fitness
```{r eval=FALSE}
PLOT_IntermediatePheno_LOGCHANGE<-ggplot(data=data_compare_longitudinal_pheno[data_compare_longitudinal_pheno$Phase=="first_prepool",], 
       aes(y=logchange,x=logchange_long, color=Fruit_s,shape=Fruit_s, linetype=Line_type)) +
  geom_errorbar(aes(x = logchange_long, 
                    ymin = logchange-(1.96*sd_logchange), 
                    ymax = logchange+(1.96*sd_logchange)),
                  width=0.02,size=0.2,alpha=1) +
  geom_errorbarh(aes(y = logchange, 
                    xmin = logchange_long-1.96*sd_logchange_long,
                    xmax = logchange_long+1.96*sd_logchange_long),
                 height=0.02,size=0.2,alpha=1) +
  geom_point(size=3, fill = "#ffffff", stroke=1.3) +
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_shape_manual(values=c(21, 22, 24)) + 
  xlab("Fitness change between average fitness across generations 2 to 5\nand average fitness across generations 2 to 5") + 
  ylab("Fitness change between\nintermediate and initial phenotyping steps") + 
  labs(color="Selection fruit", shape="Selection fruit") + 
  geom_abline(intercept = 0, slope = 1, color="black", linetype="dashed", size=0.8) +
  ylim(-1.9,0.9) + 
  xlim(-1.9,0.9) +
  guides(linetype=FALSE) +
  ggtitle("Intermediate phenotyping step vs. Phase 1") +
  theme_LO_sober 
PLOT_IntermediatePheno_LOGCHANGE 


PLOT_FinalPheno_LOGCHANGE <- 
  ggplot(data=data_compare_longitudinal_pheno
                        [data_compare_longitudinal_pheno$Phase=="second_postpool",], 
                        aes(y=logchange, x=logchange_long, 
                            color=Fruit_s, shape=Fruit_s, fill=Fruit_s, linetype=Line_type)) +
  geom_errorbar(aes(x = logchange_long, 
                    ymin = logchange-(1.96*sd_logchange),
                    ymax = logchange+(1.96*sd_logchange)),
                  width=0.02,size=0.2,alpha=1) +
  geom_errorbarh(aes(y = logchange, 
                    xmin = logchange_long-1.96*sd_logchange_long,
                    xmax = logchange_long+1.96*sd_logchange_long),
                 height=0.02,size=0.2,alpha=1) +
  geom_abline(intercept = 0, slope = 1, color="black", 
                 linetype="dashed", size=0.8) +
  geom_point(size=3, stroke=1) +
  scale_fill_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_shape_manual(values=c(21, 22, 24)) + 
  xlab("Fitness change between average fitness across generations 13 to 26\nand average fitness across generations 2 to 5") + 
  ylab("Fitness change between\nfinal and initial phenotyping steps") + 
  labs(color="Selection fruit", shape="Selection fruit", fill="Selection fruit") + 
  ylim(-0.5,1.7) +
  xlim(-0.5,1.7) +
  guides(linetype=FALSE) +
  ggtitle("Final phenotyping step vs. Phase 3") +
  theme_LO_sober
PLOT_FinalPheno_LOGCHANGE  


    

PLOT_Comparison_Pheno_Longitudinal_LOGCHANGE <- cowplot::ggdraw() +
  cowplot::draw_plot(PLOT_IntermediatePheno_LOGCHANGE + 
                       theme(axis.title.y = element_text(size=10),
                             axis.title.x = element_text(size=10)),
            x = 0, y = 0.5, width = 1, height = 0.5) +
  cowplot::draw_plot(PLOT_FinalPheno_LOGCHANGE + 
                       theme(axis.title.y = element_text(size=10),
                             axis.title.x = element_text(size=10)),
            x =0, y = 0, width = 1, height = 0.5) +
  cowplot::draw_plot_label(c("A", "B"),  
                  x = c(0,0), y = c(1,0.5), 
                  size = 14) 
PLOT_Comparison_Pheno_Longitudinal_LOGCHANGE


cowplot::save_plot(file=here::here("figures", "SUPMAT_LogChange_Pheno_Longitudinal.pdf"),
                   PLOT_Comparison_Pheno_Longitudinal_LOGCHANGE, base_height = 20/cm(1), base_width = 15/cm(1), dpi = 1200)

```




## A SUPR Extra plot Maternal effects
```{r eval=FALSE}

m <- lm(logchange ~ logchange_long + offset(logchange_long),
        data = data_compare_longitudinal_pheno[data_compare_longitudinal_pheno$Phase=="second_postpool",]) 

summary(m)
#pval of logchange_long = 0.003 => slope is different of 1 
#pval of Intercept = 0.80 => no evolution of maternal effect?


## Ratio maternal effects derived pop / maternal effect ancestral population 
exp(coef(m)[1]) 

# proportion of adaptation due to maternal effects
data_compare_longitudinal_pheno$mateff <- (data_compare_longitudinal_pheno$logchange_long -
  data_compare_longitudinal_pheno$logchange) / data_compare_longitudinal_pheno$logchange_long

data_compare_longitudinal_pheno


#Plot
PLOT_Maternaleffects<-ggplot(data=data_compare_longitudinal_pheno, 
       aes(y=mateff,x=logchange_long, color=Fruit_s, shape=Fruit_s, fill=interaction(Phase,Fruit_s))) +
  geom_point(size=3,  stroke=1.3) +
  scale_fill_manual(name = "Phase", 
                      values = c("#ffffff","#BC3C6D", "#ffffff","#FDB424", "#ffffff", "#3FAA96"), 
                      breaks = c("first_prepool.Cherry", "second_postpool.Cherry"), 
                      labels = c("Phase 1","Phase 3")) +
  scale_color_manual(values=c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_shape_manual(values=c(21, 22, 24)) + 
  xlab("Fitness change between average fitness\nacross generations 2 to 5 (13 to 26) and generation 2") + 
  ylab("Proportion of adaptation\ndue to evolution of maternal effects") + 
  labs(color="Selection fruit", shape="Selection fruit") + 
  guides(fill = guide_legend(override.aes = list(fill = c("white","black"), shape=21))) +
  theme_LO_sober 
PLOT_Maternaleffects 


cowplot::save_plot(file=here::here("figures", "SUPMAT_Maternal_effects.pdf"),
                   PLOT_Maternaleffects, base_height = 20/cm(1), base_width = 15/cm(1), dpi = 1200)


```



# SUP: Adaptation 
## Analysis Phase 1 (8 fruits)
```{r }

## Check random effect structure
mod1 <- lme4::lmer(fitness ~ Line*Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = TRUE)
mod2 <- lme4::lmer(fitness ~ Line*Generation + (1|Generation) + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = TRUE)
MuMIn::model.sel(mod1, mod2)

##Cl: the model with the same generation effect across lines does not increase the likelihood and does not provide a better fit to the data

#Models
mod_all_interaction <- lme4::lmer(fitness ~ Fruit_s*Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_generation <- lme4::lmer(fitness ~ Generation + (1|Generation:Fruit_s) , 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_fruit_generation <- lme4::lmer(fitness ~ Fruit_s+Generation + (1|Generation:Fruit_s) , 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_fruit <- lme4::lmer(fitness ~ Fruit_s + (1|Generation:Fruit_s) , 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_line <- lme4::lmer(fitness ~ Line + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_null <- lme4::lmer(fitness ~ 1  + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_all_interaction_line_generation <- lme4::lmer(fitness ~ Line*Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

mod_line_generation <- lme4::lmer(fitness ~ Line+Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN, REML = FALSE)

MuMIn::model.sel(mod_all_interaction,mod_all_fruit_generation,mod_all_fruit,mod_all_null,mod_all_generation,mod_all_line,mod_all_interaction_line_generation,mod_line_generation)

summary(mod_all_interaction)







#Posthoc
mod_all_interaction <- lme4::lmer(fitness ~ Fruit_s*Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum_allfruits_AN)
summary(mod_all_interaction)

emt1 <- emmeans::emtrends(mod_all_interaction, "Fruit_s", var = "Generation")
emt1          ### estimated slopes of Generation for each level of Fruit_s
pairs(emt1)   ### comparison of slopes



```




## Plot Phase 1 (8 fruits)
```{r }

pd <- position_dodge(0.3) # move them .05 to the left and right

#Extract slope and intercept
dat_8fruits <- expand.grid(Generation=as.numeric(levels(as.factor(data_sum_allfruits_AN$Generation))),
                           Fruit_s=unique(data_sum_allfruits_AN$Fruit_s))
dat_8fruits$fitness_predicted <- predict(mod_all_interaction, newdata = dat_8fruits, 
                          re.form= NA, type = "response")





PLOT_CHERRY <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Cherry",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Cherry",],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white",stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  ylab("Fitness") + 
  xlab("Generation") + 
  xlim("1","2","3","4","5") +
  scale_color_manual(values = c("black", "#BC3C6D")) + 
  ggtitle("Cherry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#BC3C6D"))
PLOT_CHERRY



PLOT_CRANBERRY <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Cranberry",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Cranberry",],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white",stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  ylab("Fitness") + 
  xlim("1","2","3","4","5") +
  xlab("Generation") + 
  scale_color_manual(values = c("black","#FDB424")) + 
  ggtitle("Cranberry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#FDB424"))
PLOT_CRANBERRY


PLOT_STRAWBERRY <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Strawberry",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Strawberry",],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white",stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c("black","#3FAA96")) + 
  ggtitle("Strawberry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#3FAA96"))
PLOT_STRAWBERRY



PLOT_GRAPE <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Grape",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Grape"&dat_8fruits$Generation == c(2,3),],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white",stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c("black","#7B7554")) + 
  ggtitle("Grape") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#7B7554"))
PLOT_GRAPE

PLOT_ROSEHIPS <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Rosehips",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Rosehips"&dat_8fruits$Generation != 5,],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white",stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c("black","#8ACDEA")) + 
  ggtitle("Rose hips") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#8ACDEA"))
PLOT_ROSEHIPS



PLOT_TOMATO <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Tomato",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Tomato"&dat_8fruits$Generation != 5,],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white", stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c( "black","#ED6F47")) + 
  ggtitle("Tomato") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#ED6F47"))
PLOT_TOMATO


PLOT_FIG <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Fig",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Fig"&dat_8fruits$Generation != 5,],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white", stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c("black","#93194F")) + 
  ggtitle("Fig") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#93194F"))
PLOT_FIG


PLOT_BLACKCURRANT <- ggplot(data = data_sum_allfruits[data_sum_allfruits$Fruit_s == "Blackcurrant",], 
                            aes(x = factor(Generation), group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin = fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.4,color = "black") + 
  geom_line(size = 0.5,position = pd) + 
  geom_line(data = dat_8fruits[dat_8fruits$Fruit_s == "Blackcurrant"&dat_8fruits$Generation == c(2,3),],
                     aes(x = factor(Generation), y = fitness_predicted, colour = "black", group=NA), size = 0.7) +
  geom_point(size = 2, position = pd, shape = 21, fill = "white", stroke = 1.2) + 
  ylim(-5.65, 1.25) +
  xlim("1","2","3","4","5") +
  ylab("Fitness") + 
  xlab("Generation") + 
  scale_color_manual(values = c( "black","#203753")) + 
  ggtitle("Blackcurrant") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#203753"))
PLOT_BLACKCURRANT


DYNAMIC_EIGHT_JOIN <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_STRAWBERRY, x = 0, y = 0, width = 0.5, height = 0.28) + 
  cowplot::draw_plot(PLOT_GRAPE+ theme(axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0, y = 0.28, width = 0.5, height = 0.23) + 
  cowplot::draw_plot(PLOT_CRANBERRY+ theme(axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0, y = 0.53, width = 0.5, height = 0.23) + 
  cowplot::draw_plot(PLOT_BLACKCURRANT+ theme(axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0, y = 0.77, width = 0.5, height = 0.23) + 
  cowplot::draw_plot(PLOT_TOMATO+ theme(axis.title.y = element_blank()), 
                     x = 0.5, y = 0, width = 0.5, height = 0.28) + 
  cowplot::draw_plot(PLOT_ROSEHIPS+ theme(axis.title.y = element_blank(),
                                              axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0.5, y = 0.28, width = 0.5, height = 0.23) + 
  cowplot::draw_plot(PLOT_FIG+ theme(axis.title.y = element_blank(),
                                              axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0.5, y = 0.53, width = 0.5, height = 0.23) + 
  cowplot::draw_plot(PLOT_CHERRY + theme(axis.title.y = element_blank(),
                                              axis.title.x = element_blank(),
                                              axis.text.x = element_blank(),
                                              axis.ticks.x = element_blank(),
                                              axis.line.x = element_blank()),
                     x = 0.5, y = 0.77, width = 0.5, height = 0.23) +
  cowplot::draw_plot_label(c("A", "C",  "E", "G", "B",  "D", "F",  "H"),  
                  x = c(0, 0, 0, 0, 0.5, 0.5, 0.5, 0.5), 
                  y = c(1, 0.75, 0.50, 0.27, 1, 0.75, 0.5, 0.27), 
                  hjust = c(-0.5, -0.5, -0.5,-0.5, -0.5, -0.5, -0.5, -0.5), 
                  vjust = c(1.5, 1.5, 1.5,1.5, 1.5, 1.5,1.5, 1.5),
                  size = 12) 
 DYNAMIC_EIGHT_JOIN



cowplot::save_plot(file =here::here("figures", "SUPMAT_Fitness8Fruits.pdf"), DYNAMIC_EIGHT_JOIN, base_height = 17/cm(1), base_width = 15/cm(1), dpi = 1200)



```





## Analysis PHASE 3    
```{r }


################### PHASE 3



## Test for random effects
mod0 <- lme4::lmer(fitness~ Generation*Line + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = TRUE)
mod1 <- lme4::lmer(fitness~ Generation*Line + (1|Generation) + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = TRUE)
MuMIn::model.sel(mod0, mod1)
## Cl: only a very slight increase in likelihood when adding the second random effect

## Test for fixed effects
mod1 <- lme4::lmer(fitness ~ 1 + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE) 
mod2 <- lme4::lmer(fitness~ Line  + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE)
mod3 <- lme4::lmer(fitness ~ Fruit_s  + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE) 
mod4 <- lme4::lmer(fitness~ Generation*Line + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE)
mod5 <- lme4::lmer(fitness~ Generation+Line + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE)
mod6 <- lme4::lmer(fitness ~ Generation*Fruit_s + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE) 
mod7 <- lme4::lmer(fitness ~ Generation+Fruit_s + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE) 
mod8 <- lme4::lmer(fitness ~ Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",], REML = FALSE) 


anova(mod1,mod2)
MuMIn::model.sel(mod1,mod2,mod3,mod4,mod5,mod6, mod7, mod8)



mod3 <- lme4::lmer(fitness ~ Fruit_s-1 + (1|Generation) + (1|Generation:Fruit_s), 
            weights = N, data = data_sum[data_sum$Phase=="second_postpool",]) 

summary(mod3)
```


# SUP: Correlated responses for other traits 
## Formating data
```{r }
#Formatting for fecundity
TEMP_dataG7_CheCran_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                           fruitcomb=c("Cherry", "Cranberry"), trait="fecundity")
TEMP_dataG7_CranStraw_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                             fruitcomb=c("Strawberry", "Cranberry"), trait="fecundity")
TEMP_dataG7_StrawChe_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                            fruitcomb=c("Cherry", "Strawberry"), trait="fecundity")

TEMP_dataG29_CheCran_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                            fruitcomb=c("Cherry", "Cranberry"), trait="fecundity")
TEMP_dataG29_CranStraw_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                              fruitcomb=c("Strawberry", "Cranberry"), trait="fecundity")
TEMP_dataG29_StrawChe_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                             fruitcomb=c("Cherry", "Strawberry"), trait="fecundity")



#Formatting for egg to adult viability
TEMP_dataG7_CheCran_Viability <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                           fruitcomb=c("Cherry", "Cranberry"), trait="eggtoad")
TEMP_dataG7_CranStraw_Viability  <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                             fruitcomb=c("Strawberry", "Cranberry"), trait="eggtoad")
TEMP_dataG7_StrawChe_Viability  <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                            fruitcomb=c("Cherry", "Strawberry"), trait="eggtoad")

TEMP_dataG29_CheCran_Viability  <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                            fruitcomb=c("Cherry", "Cranberry"), trait="eggtoad")
TEMP_dataG29_CranStraw_Viability  <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                              fruitcomb=c("Strawberry", "Cranberry"), trait="eggtoad")
TEMP_dataG29_StrawChe_Viability  <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                             fruitcomb=c("Cherry", "Strawberry"), trait="eggtoad")
```



## Plot Fecundity 
```{r } 
#Formating data
ymin = -50
ymax = 50

##################################################
##################   G7
# Limits
ymin_CheCranG7=min(min(TEMP_dataG7_CheCran_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CheCran_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE)) 
ymax_CheCranG7=max(max(TEMP_dataG7_CheCran_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CheCran_Fecundity$upCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-2



# Plot
CheCran_G7 <- ggplot(data = TEMP_dataG7_CheCran_Fecundity) + 
  geom_errorbar(aes(x = logfecundchange_symp, ymin = lowCIlogfecundchange_allop,
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logfecundchange_allop, xmin = lowCIlogfecundchange_symp, 
                     xmax = upCIlogfecundchange_symp, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange_symp, y = logfecundchange_allop,  
                 color = Fruit_s,fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change in\nselective environment")  + 
  ylab("Log fecundity change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  theme_LO_sober + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG7, ymax_CheCranG7), 
                  xlim = c(ymin_CheCranG7, ymax_CheCranG7)) 
  
 CheCran_G7


# Limits
ymin_CranStrawG7=min(min(TEMP_dataG7_CranStraw_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CranStraw_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
ymax_CranStrawG7=max(max(TEMP_dataG7_CranStraw_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CranStraw_Fecundity$upCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG7+0.99*(ymax_CranStrawG7-ymin_CranStrawG7)


CranStraw_G7 <-  ggplot(data = TEMP_dataG7_CranStraw_Fecundity) + 
  geom_errorbar(aes(x = logfecundchange_symp, ymin = lowCIlogfecundchange_allop, 
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logfecundchange_allop, xmin = lowCIlogfecundchange_symp, 
                     xmax = upCIlogfecundchange_allop, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logfecundchange_symp, y = logfecundchange_allop,  color = Fruit_s,
                 fill = Fruit_s, shape = Treatment),
                   size =3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change in\nselective environment")  + 
  ylab("Log fecundity change in\nalternative environment")  + 
     ggtitle("Cranberry vs. Strawberry") + 
  coord_cartesian(ylim = c(ymin_CranStrawG7, ymax_CranStrawG7), 
                  xlim = c(ymin_CranStrawG7, ymax_CranStrawG7)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(22, 24)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
  theme_LO_sober
 CranStraw_G7

 
# Limits
ymin_StrawCheG7=min(min(TEMP_dataG7_StrawChe_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_StrawChe_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
ymax_StrawCheG7=max(max(TEMP_dataG7_StrawChe_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_StrawChe_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG7+0.99*(ymax_StrawCheG7-ymin_StrawCheG7)


StrawChe_G7 <-  ggplot(data = TEMP_dataG7_StrawChe_Fecundity) + 
  geom_errorbar(aes(x =logfecundchange_symp, 
                    ymin = lowCIlogfecundchange_allop, 
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logfecundchange_allop, 
                     xmin = lowCIlogfecundchange_symp, 
                     xmax = upCIlogfecundchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logfecundchange_symp, y = logfecundchange_allop,  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change in\nselective environment")  + 
  ylab("Log fecundity change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(21, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  coord_cartesian(ylim = c(ymin_StrawCheG7, ymax_StrawCheG7), 
                  xlim = c(ymin_StrawCheG7, ymax_StrawCheG7)) + 
  theme_LO_sober
 StrawChe_G7
 
 
  
#####################################################################################
##################################      G29        ##################################
#####################################################################################
TEMP_dataG29_CheCran
TEMP_dataG29_CranStraw
TEMP_dataG29_StrawChe


# Limits
ymin_CheCranG29=min(min(TEMP_dataG29_CheCran_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CheCran_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
ymax_CheCranG29=max(max(TEMP_dataG29_CheCran_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CheCran_Fecundity$upCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-ymin_CheCranG29+0.99*(ymax_CheCranG29-ymin_CheCranG29)


CheCran_G29 <- ggplot(data = TEMP_dataG29_CheCran_Fecundity) + 
  geom_errorbar(aes(x =logfecundchange_symp, ymin = lowCIlogfecundchange_allop, 
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logfecundchange_allop, xmin = lowCIlogfecundchange_symp, 
                     xmax = upCIlogfecundchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logfecundchange_symp, y = logfecundchange_allop,  color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Log fecundity change in\nselective environment")  + 
  ylab("Log fecundity change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG29, ymax_CheCranG29), 
                  xlim = c(ymin_CheCranG29, ymax_CheCranG29)) + 
  theme_LO_sober
 CheCran_G29



# Limits
ymin_CranStrawG29=min(min(TEMP_dataG29_CranStraw_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CranStraw_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
ymax_CranStrawG29=max(max(TEMP_dataG29_CranStraw_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CranStraw_Fecundity$upCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG29+0.99*(ymax_CranStrawG29-ymin_CranStrawG29)

#Plot
 CranStraw_G29 <- ggplot(data = TEMP_dataG29_CranStraw_Fecundity) + 
   geom_errorbar(aes(x =logfecundchange_symp, ymin = lowCIlogfecundchange_allop, 
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
   geom_errorbarh(aes(y = logfecundchange_allop, xmin = lowCIlogfecundchange_symp,
                      xmax = upCIlogfecundchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
   geom_point(aes(x =logfecundchange_symp, y = logfecundchange_allop,  
                  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
   xlab("Log fecundity change in\nselective environment")  + 
   ylab("Log fecundity change in\nalternative environment")  + 
   ggtitle("Cranberry vs. Strawberry") + 
   coord_cartesian(ylim = c(ymin_CranStrawG29, ymax_CranStrawG29), 
                  xlim = c(ymin_CranStrawG29, ymax_CranStrawG29)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(15, 17)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
   theme_LO_sober
 CranStraw_G29

 
 
 
# Limits
ymin_StrawCheG29=min(min(TEMP_dataG29_StrawChe_Fecundity$lowCIlogfecundchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_StrawChe_Fecundity$lowCIlogfecundchange_symp, na.rm= TRUE))
ymax_StrawCheG29=max(max(TEMP_dataG29_StrawChe_Fecundity$upCIlogfecundchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_StrawChe_Fecundity$upCIlogfecundchange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG29+0.99*(ymax_StrawCheG29-ymin_StrawCheG29)


StrawChe_G29 <- ggplot(data = TEMP_dataG29_StrawChe_Fecundity) + 
  geom_errorbar(aes(x =logfecundchange_symp, ymin = lowCIlogfecundchange_allop, 
                    ymax = upCIlogfecundchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(aes(y = logfecundchange_allop, xmin = lowCIlogfecundchange_symp, 
                     xmax = upCIlogfecundchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(aes(x =logfecundchange_symp, y = logfecundchange_allop,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  coord_cartesian(ylim = c(ymin_StrawCheG29, ymax_StrawCheG29), 
                  xlim = c(ymin_StrawCheG29, ymax_StrawCheG29)) + 
    xlab("Log fecundity change in\nselective environment")  + 
    ylab("Log fecundity change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  theme_LO_sober
 StrawChe_G29





 
 
legend_tradevide <-  ggplot(data = data_logchange[data_logchange$Generation == "29",],
                          aes(x =logchange, y = logchange,  color = Fruit_s, fill = Fruit_s, 
                              shape = Treatment)) + 
  geom_point(size =2.5, fill = "white") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober

legend_trade <- lemon::g_legend(legend_tradevide)

 
 

Slopeestimates_logchange_pairwise_errorbar_FECUNDITY <- cowplot::ggdraw() + 
  cowplot::draw_plot(CheCran_G7 + theme(legend.position = "none"), 
            x = 0.01, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G7 + theme(legend.position = "none"), 
            x = 0.31, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G7 + theme(legend.position = "none"), 
            x = 0.61, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(legend_trade, x = 0.85, y = 0.5, width = 0.1, height = 0.1) + 
  cowplot::draw_plot(CheCran_G29 + theme(legend.position = "none"), 
            x = 0.01, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G29 + theme(legend.position = "none"), 
            x = 0.31, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G29 + theme(legend.position = "none"), 
            x = 0.61, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", "B", "C", " ",
                    "Final phenotyping step", "D", "E", "F", " "),  
                  x = c(0.30, 0.01, 0.30, 0.61, 0.92, 0.250, 0.01, 0.30, 0.61, 0.92), 
                  y = c(0.99, 0.95, 0.95, 0.95, 0.95, 0.49, 0.45, 0.45, 0.45, 0.45), 
                  hjust = c(-0.25, -0.25, -0.25, -0.25, -0.25, -0.75, -0.75, -0.75, -0.75, -0.75), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 Slopeestimates_logchange_pairwise_errorbar_FECUNDITY
#  
# #  
# 
cowplot::save_plot(file =here::here("figures", "SUPMAT_Correlation_Fecundity.pdf"),
                   Slopeestimates_logchange_pairwise_errorbar_FECUNDITY,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)




```




## Plot Egg to adult viability 
```{r } 
#Formating data
ymin = -50
ymax = 50

##################################################
##################   G7
# Limits
ymin_CheCranG7=min(min(TEMP_dataG7_CheCran_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CheCran_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE)) 
ymax_CheCranG7=max(max(TEMP_dataG7_CheCran_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CheCran_Viability$upCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-2



# Plot
CheCran_G7 <- ggplot(data = TEMP_dataG7_CheCran_Viability) + 
  geom_errorbar(aes(x = logeggtoadchange_symp, ymin = lowCIlogeggtoadchange_allop,
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange_allop, xmin = lowCIlogeggtoadchange_symp, 
                     xmax = upCIlogeggtoadchange_symp, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logeggtoadchange_symp, y = logeggtoadchange_allop,  
                 color = Fruit_s,fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  theme_LO_sober + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG7, ymax_CheCranG7), 
                  xlim = c(ymin_CheCranG7, ymax_CheCranG7)) 
  
 CheCran_G7


# Limits
ymin_CranStrawG7=min(min(TEMP_dataG7_CranStraw_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CranStraw_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
ymax_CranStrawG7=max(max(TEMP_dataG7_CranStraw_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CranStraw_Viability$upCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG7+0.99*(ymax_CranStrawG7-ymin_CranStrawG7)


CranStraw_G7 <-  ggplot(data = TEMP_dataG7_CranStraw_Viability) + 
  geom_errorbar(aes(x = logeggtoadchange_symp, ymin = lowCIlogeggtoadchange_allop, 
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange_allop, xmin = lowCIlogeggtoadchange_symp, 
                     xmax = upCIlogeggtoadchange_allop, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logeggtoadchange_symp, y = logeggtoadchange_allop,  color = Fruit_s,
                 fill = Fruit_s, shape = Treatment),
                   size =3, fill = "white", stroke =1.2) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  +  
     ggtitle("Cranberry vs. Strawberry") + 
  coord_cartesian(ylim = c(ymin_CranStrawG7, ymax_CranStrawG7), 
                  xlim = c(ymin_CranStrawG7, ymax_CranStrawG7)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(22, 24)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
  theme_LO_sober
 CranStraw_G7

 
# Limits
ymin_StrawCheG7=min(min(TEMP_dataG7_StrawChe_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG7_StrawChe_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
ymax_StrawCheG7=max(max(TEMP_dataG7_StrawChe_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG7_StrawChe_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG7+0.99*(ymax_StrawCheG7-ymin_StrawCheG7)


StrawChe_G7 <-  ggplot(data = TEMP_dataG7_StrawChe_Viability) + 
  geom_errorbar(aes(x =logeggtoadchange_symp, 
                    ymin = lowCIlogeggtoadchange_allop, 
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange_allop, 
                     xmin = lowCIlogeggtoadchange_symp, 
                     xmax = upCIlogeggtoadchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logeggtoadchange_symp, y = logeggtoadchange_allop,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(21, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  coord_cartesian(ylim = c(ymin_StrawCheG7, ymax_StrawCheG7), 
                  xlim = c(ymin_StrawCheG7, ymax_StrawCheG7)) + 
  theme_LO_sober
 StrawChe_G7
 
 
  
#####################################################################################
##################################      G29        ##################################
#####################################################################################
TEMP_dataG29_CheCran
TEMP_dataG29_CranStraw
TEMP_dataG29_StrawChe


# Limits
ymin_CheCranG29=min(min(TEMP_dataG29_CheCran_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CheCran_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
ymax_CheCranG29=max(max(TEMP_dataG29_CheCran_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CheCran_Viability$upCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-ymin_CheCranG29+0.99*(ymax_CheCranG29-ymin_CheCranG29)


CheCran_G29 <- ggplot(data = TEMP_dataG29_CheCran_Viability) + 
  geom_errorbar(aes(x =logeggtoadchange_symp, ymin = lowCIlogeggtoadchange_allop, 
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logeggtoadchange_allop, xmin = lowCIlogeggtoadchange_symp, 
                     xmax = upCIlogeggtoadchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logeggtoadchange_symp, y = logeggtoadchange_allop,  color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG29, ymax_CheCranG29), 
                  xlim = c(ymin_CheCranG29, ymax_CheCranG29)) + 
  theme_LO_sober
 CheCran_G29



# Limits
ymin_CranStrawG29=min(min(TEMP_dataG29_CranStraw_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CranStraw_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
ymax_CranStrawG29=max(max(TEMP_dataG29_CranStraw_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CranStraw_Viability$upCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG29+0.99*(ymax_CranStrawG29-ymin_CranStrawG29)

#Plot
 CranStraw_G29 <- ggplot(data = TEMP_dataG29_CranStraw_Viability) + 
   geom_errorbar(aes(x =logeggtoadchange_symp, ymin = lowCIlogeggtoadchange_allop, 
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
   geom_errorbarh(aes(y = logeggtoadchange_allop, xmin = lowCIlogeggtoadchange_symp,
                      xmax = upCIlogeggtoadchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
   geom_point(aes(x =logeggtoadchange_symp, y = logeggtoadchange_allop,  
                  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  + 
   ggtitle("Cranberry vs. Strawberry") + 
   coord_cartesian(ylim = c(ymin_CranStrawG29, ymax_CranStrawG29), 
                  xlim = c(ymin_CranStrawG29, ymax_CranStrawG29)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(15, 17)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
   theme_LO_sober
 CranStraw_G29

 
 
 
# Limits
ymin_StrawCheG29=min(min(TEMP_dataG29_StrawChe_Viability$lowCIlogeggtoadchange_allop, na.rm= TRUE),
                min(TEMP_dataG29_StrawChe_Viability$lowCIlogeggtoadchange_symp, na.rm= TRUE))
ymax_StrawCheG29=max(max(TEMP_dataG29_StrawChe_Viability$upCIlogeggtoadchange_allop, na.rm= TRUE),
                max(TEMP_dataG29_StrawChe_Viability$upCIlogeggtoadchange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG29+0.99*(ymax_StrawCheG29-ymin_StrawCheG29)


StrawChe_G29 <- ggplot(data = TEMP_dataG29_StrawChe_Viability) + 
  geom_errorbar(aes(x =logeggtoadchange_symp, ymin = lowCIlogeggtoadchange_allop, 
                    ymax = upCIlogeggtoadchange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(aes(y = logeggtoadchange_allop, xmin = lowCIlogeggtoadchange_symp, 
                     xmax = upCIlogeggtoadchange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(aes(x =logeggtoadchange_symp, y = logeggtoadchange_allop,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  coord_cartesian(ylim = c(ymin_StrawCheG29, ymax_StrawCheG29), 
                  xlim = c(ymin_StrawCheG29, ymax_StrawCheG29)) + 
  xlab("Logit egg-to-adult viability\nchange in selective environment")  + 
  ylab("Logit egg-to-adult viability\nchange in alternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  theme_LO_sober
 StrawChe_G29





 
 
legend_tradevide <-  ggplot(data = data_logchange[data_logchange$Generation == "29",],
                          aes(x =logchange, y = logchange,  color = Fruit_s, fill = Fruit_s, 
                              shape = Treatment)) + 
  geom_point(size =2.5, fill = "white") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober

legend_trade <- lemon::g_legend(legend_tradevide)

 
 

Slopeestimates_logchange_pairwise_errorbar_VIABILITY <- cowplot::ggdraw() + 
  cowplot::draw_plot(CheCran_G7 + theme(legend.position = "none"), 
            x = 0.01, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G7 + theme(legend.position = "none"), 
            x = 0.31, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G7 + theme(legend.position = "none"), 
            x = 0.61, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(legend_trade, x = 0.85, y = 0.5, width = 0.1, height = 0.1) + 
  cowplot::draw_plot(CheCran_G29 + theme(legend.position = "none"), 
            x = 0.01, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G29 + theme(legend.position = "none"), 
            x = 0.31, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G29 + theme(legend.position = "none"), 
            x = 0.61, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", "B", "C", " ",
                    "Final phenotyping step", "D", "E", "F", " "),  
                  x = c(0.30, 0.01, 0.30, 0.61, 0.92, 0.250, 0.01, 0.30, 0.61, 0.92), 
                  y = c(0.99, 0.95, 0.95, 0.95, 0.95, 0.49, 0.45, 0.45, 0.45, 0.45), 
                  hjust = c(-0.25, -0.25, -0.25, -0.25, -0.25, -0.75, -0.75, -0.75, -0.75, -0.75), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 Slopeestimates_logchange_pairwise_errorbar_VIABILITY
#  
# #  
# 
cowplot::save_plot(file =here::here("figures", "SUPMAT_Correlation_Eggtoadultviability.pdf"),
                   Slopeestimates_logchange_pairwise_errorbar_VIABILITY,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)




```


# SUP: Pooling effect
## Data
```{r eval=FALSE}

########### Hypothesis 1 
#Hypothesis 1: effect of pool 
#Take the mean of all populations for each selection fruit 
 
CheCran_hypo1 <- computelogchange_POOL_hypo1(data_G7, "Cherry", "Cranberry")



########### Hypothesis 2 
#Hypothesis 2: effect of pool 
#Take the fitness change of the population with the highest fitness in G7 
TEMP_dataG7_CheCran <- formattinglogchange(data_logchange, "7", "Cherry", "Cranberry")
fittest_lines<-computelogchange_POOL_hypo2(data_G7, "Cherry", "Cranberry")
CheCran_hypo2<-TEMP_dataG7_CheCran[TEMP_dataG7_CheCran$Line==fittest_lines,]




```

## Plot
```{r eval=FALSE}
#Initial plot from main text
ymin = -50
ymax = 50


pd <- position_dodge(0.3) # move them .05 to the left and right

# Limits
ymin_CheCranG29=min(min(TEMP_dataG29_CheCran$logchange_allop-1.96*TEMP_dataG29_CheCran$sd_allop, na.rm= TRUE),
                min(TEMP_dataG29_CheCran$logchange_symp-1.96*TEMP_dataG29_CheCran$sd_symp, na.rm= TRUE))
ymax_CheCranG29=max(max(TEMP_dataG29_CheCran$logchange_allop + 1.96*TEMP_dataG29_CheCran$sd_allop, na.rm= TRUE),
                max(TEMP_dataG29_CheCran$logchange_symp + 1.96*TEMP_dataG29_CheCran$sd_symp, na.rm= TRUE))


CheCran_G29 <- ggplot(data = TEMP_dataG29_CheCran) + 
  geom_errorbar(aes(x =logchange_symp, ymin = logchange_allop-(1.96*sd_allop), 
                    ymax = logchange_allop + (1.96*sd_allop),
                    color = Symp),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = logchange_symp-1.96*sd_symp, xmax = logchange_symp + 1.96*sd_symp, 
                 color = Symp),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  color = Symp,fill = Symp, shape = Allop),
                 size =3, fill = "white", stroke =1.2) + 
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG29, ymax_CheCranG29), 
                  xlim = c(ymin_CheCranG29, ymax_CheCranG29)) + 
  theme_LO_sober
 CheCran_G29
 
 
 
 

PLOT_HYPO_1<-CheCran_G29 +  
  geom_errorbar(data = CheCran_hypo1, aes(x =logchange_symp, ymin = logchange_allop-(1.96*sd_allop), 
                    ymax = logchange_allop + (1.96*sd_allop),
                    color = Symp),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(data = CheCran_hypo1, 
                 aes(y = logchange_allop, xmin = logchange_symp-1.96*sd_symp, xmax = logchange_symp + 1.96*sd_symp, 
                 color = Symp),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(data = CheCran_hypo1,
             aes(x =logchange_symp, y = logchange_allop,  color = Symp,fill = Symp, shape = Allop),
                 size = 6, fill = "white", stroke = 2) +
    geom_point(data = CheCran_hypo1,
             aes(x =logchange_symp, y = logchange_allop,  fill = Symp, shape = Allop),
                 size = 3, fill = "white", color = "white", stroke = 2) +
  ggtitle("Hypothesis 1: Mean of populations effect")
PLOT_HYPO_1



PLOT_HYPO_2<-CheCran_G29 +  
  geom_errorbar(data = CheCran_hypo2, aes(x = logchange_symp, 
                                          ymin = logchange_allop-(1.96*sd_allop), 
                    ymax = logchange_allop + (1.96*sd_allop),
                    color = Symp),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(data = CheCran_hypo2, 
                 aes(y = logchange_allop, xmin = logchange_symp-1.96*sd_symp, xmax = logchange_symp + 1.96*sd_symp, 
                 color = Symp),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(data = CheCran_hypo2,
             aes(x =logchange_symp, y = logchange_allop,  color = Symp,fill = Symp, shape = Allop),
                 size = 6, fill = "white", stroke = 2) +
    geom_point(data = CheCran_hypo2,
             aes(x = logchange_symp, y = logchange_allop,  fill = Symp, shape = Allop),
                 size = 3, fill = "white", color = "white", stroke = 2) +
  ggtitle("Hypothesis 2: Fittest population effect")
PLOT_HYPO_2






#legend1
legend_tradevide<- ggplot(CheCran_hypo2, aes(x=logchange_symp, y=logchange_allop, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  geom_errorbar(aes(ymin=logchange_allop-(1.96*sd_allop), ymax=logchange_allop+(1.96*sd_allop),),
                  width=0.4,size=0.4, alpha=0.3) +
  labs(colour = "Population \nevolved on:") + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))

legend_tradevide<-lemon::g_legend(legend_tradevide)

 #legend hypo 1
legend_hypo1<- ggplot(CheCran_hypo2, aes(x=logchange_symp, y=logchange_allop, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  geom_errorbar(aes(ymin=logchange_allop-(1.96*sd_allop), ymax=logchange_allop+(1.96*sd_allop),),
                  width=0.4,size=0.4, alpha=0.3) +
  labs(colour = "Mean of population\nevolved on:") + 
  geom_point(size=2, shape=21, fill="white", stroke = 2) + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))

extract_legend_hypo1<-lemon::g_legend(legend_hypo1)

 #legend2
legend_hypo2<- ggplot(CheCran_hypo2, aes(x=logchange_symp, y=logchange_allop, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  geom_errorbar(aes(ymin=logchange_allop-(1.96*sd_allop), ymax=logchange_allop+(1.96*sd_allop),),
                  width=0.4,size=0.4, alpha=0.3) +
  labs(colour = "Population with \nthe highest fitness \non each selection fruit:") + 
  geom_point(size=2, shape=21, fill="white", stroke = 2) + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))

extract_legend_hypo2<-lemon::g_legend(legend_hypo2)



ERRORCROSSES_G7_HYPO1_2 <- cowplot::ggdraw() +
  cowplot::draw_plot(PLOT_HYPO_1+theme(legend.position = "none"), 
            x =0.00, y = 0.5, width = 0.75, height = 0.5) +
  cowplot::draw_plot(PLOT_HYPO_2+theme(legend.position = "none"), 
            x = 0.0, y = 0, width = 0.75, height = 0.5) +
  cowplot::draw_plot(legend_tradevide, x = 0.78, y = 0.85, width = 0.1, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo1, x = 0.82, y = 0.7, width = 0.1, height = 0.1) +
  cowplot::draw_plot(legend_tradevide, x = 0.76, y = 0.35, width = 0.1, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo2, x = 0.82, y = 0.2, width = 0.1, height = 0.1) 
ERRORCROSSES_G7_HYPO1_2





ERRORCROSSES_G7_HYPO1 <- cowplot::ggdraw() +
  cowplot::draw_plot(PLOT_HYPO_1+theme(legend.position = "none", 
                                       plot.title = element_blank()), 
            x =0.00, y = 0, width = 0.75, height = 1) +
  cowplot::draw_plot(legend_tradevide, x = 0.78, y = 0.3, width = 0.1, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo1, x = 0.82, y = 0.55, width = 0.1, height = 0.1)
ERRORCROSSES_G7_HYPO1

ERRORCROSSES_G7_HYPO2 <- cowplot::ggdraw() +
  cowplot::draw_plot(PLOT_HYPO_2+theme(legend.position = "none", 
                                       plot.title = element_blank()), 
            x =0.00, y = 0, width = 0.75, height = 1) +
  cowplot::draw_plot(legend_tradevide, x = 0.76, y = 0.3, width = 0.1, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo2, x = 0.82, y = 0.55, width = 0.1, height = 0.1)
ERRORCROSSES_G7_HYPO2




# 
# cowplot::save_plot(file =here::here("figures", "SUPMAT_Pooleffect_Hypothesis.pdf"),
#                    ERRORCROSSES_G7_HYPO1_2,
#                    base_height = 18/cm(1), base_width = 15/cm(1), dpi = 610)
# 
# 

cowplot::save_plot(file =here::here("figures", "SUPMAT_Pooleffect_Hypothesis1.pdf"),
                   ERRORCROSSES_G7_HYPO1,
                   base_height = 12/cm(1), base_width = 15/cm(1), dpi = 610)


cowplot::save_plot(file =here::here("figures", "SUPMAT_Pooleffect_Hypothesis2.pdf"),
                   ERRORCROSSES_G7_HYPO2,
                   base_height = 12/cm(1), base_width = 15/cm(1), dpi = 610)







```








## A SUPR
```{r eval=FALSE} 
PAIR_StrawChe_G29
PAIR_CranStraw_G29
PAIR_CheCran_G29


## Data
# EC_Cran_Cher_G7<-formattingplotpair(data_logchange, "7", "Cherry", "Cranberry")
# EC_Straw_Cran_G7<-formattingplotpair(data_logchange, "7", "Cranberry", "Strawberry")
# EC_Straw_Cher_G7<-formattingplotpair(data_logchange, "7", "Strawberry", "Cherry")

########### Hypothesis 1 
#Hypothesis 1: effect of pool 
#Take the mean of all populations for each selection fruit 
dataset_hypo1 <- formatting_POOL_hypo1(fitness_dataset_intermediate = data_G7)

########### Hypothesis 2 
#Hypothesis 2: effect of pool 
#Take the fitness change of the population with the highest fitness in G7 
fittest_lines<-formatting_POOL_hypo2(data_G7)
EC_Cran_Cher_hypo2<-EC_Cran_Cher_G7[EC_Cran_Cher_G7$Line == fittest_lines[1]|
                                      EC_Cran_Cher_G7$Line == fittest_lines[2]|
                                      EC_Cran_Cher_G7$Line == fittest_lines[3],]
EC_Straw_Cran_hypo2<-EC_Straw_Cran_G7[EC_Straw_Cran_G7$Line == fittest_lines[1]|
                                       EC_Straw_Cran_G7$Line == fittest_lines[2]|
                                        EC_Straw_Cran_G7$Line == fittest_lines[3],]
EC_Straw_Cher_hypo2<-EC_Straw_Cher_G7[EC_Straw_Cher_G7$Line == fittest_lines[1]|
                                       EC_Straw_Cher_G7$Line == fittest_lines[2]|
                                        EC_Straw_Cher_G7$Line == fittest_lines[3],]


PAIR_CheCran_G29_HYPO_1 <- PAIR_CheCran_G29 +
  geom_errorbar(data = dataset_hypo1, 
                aes(x=logchange_Strawberry, 
                    ymin = logchange_Cranberry-1.96*sd_logchange_Cranberry,
                    ymax = logchange_Cranberry+1.96*sd_logchange_Cranberry, Line=NA),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = dataset_hypo1, 
                 aes(y=logchange_Cranberry, 
                     xmin = logchange_Strawberry-1.96*sd_logchange_Strawberry,
                     xmax = logchange_Strawberry+1.96*sd_logchange_Strawberry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = dataset_hypo1, 
             aes(x = logchange_Strawberry, y = logchange_Cranberry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_CheCran_G29_HYPO_1


PAIR_StrawChe_G29_HYPO_1<-PAIR_StrawChe_G29 +
  geom_errorbar(data = dataset_hypo1, 
                aes(x=logchange_Strawberry, 
                    ymin = logchange_Cranberry-1.96*sd_logchange_Cranberry,
                    ymax = logchange_Cranberry+1.96*sd_logchange_Cranberry, Line=NA),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = dataset_hypo1, 
                 aes(y=logchange_Cranberry, 
                     xmin = logchange_Strawberry-1.96*sd_logchange_Strawberry,
                     xmax = logchange_Strawberry+1.96*sd_logchange_Strawberry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = dataset_hypo1, 
             aes(x = logchange_Strawberry, y = logchange_Cranberry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_StrawChe_G29_HYPO_1


PAIR_CranStraw_G29_HYPO_1<-PAIR_StrawChe_G29  + 
  geom_errorbar(data = dataset_hypo1, 
                aes(x=logchange_Strawberry, 
                    ymin = logchange_Cranberry-1.96*sd_logchange_Cranberry,
                    ymax = logchange_Cranberry+1.96*sd_logchange_Cranberry, Line=NA),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = dataset_hypo1, 
                 aes(y=logchange_Cranberry, 
                     xmin = logchange_Strawberry-1.96*sd_logchange_Strawberry,
                     xmax = logchange_Strawberry+1.96*sd_logchange_Strawberry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = dataset_hypo1, 
             aes(x = logchange_Strawberry, y = logchange_Cranberry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_CranStraw_G29_HYPO_1
 












PAIR_CranStraw_G29_HYPO_2 <- PAIR_CranStraw_G29 +
  geom_errorbar(data = EC_Straw_Cran_hypo2, 
                aes(x=logchange_Strawberry, 
                    ymin = logchange_Cranberry-1.96*sd_logchange_Cranberry,
                    ymax = logchange_Cranberry+1.96*sd_logchange_Cranberry),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = EC_Straw_Cran_hypo2, 
                 aes(y=logchange_Cranberry, 
                     xmin = logchange_Strawberry-1.96*sd_logchange_Strawberry,
                     xmax = logchange_Strawberry+1.96*sd_logchange_Strawberry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = EC_Straw_Cran_hypo2, 
             aes(x = logchange_Strawberry, y = logchange_Cranberry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_CranStraw_G29_HYPO_2



PAIR_StrawChe_G29_HYPO_2 <- PAIR_StrawChe_G29 +
  geom_errorbar(data = EC_Straw_Cher_hypo2, 
                aes(x=logchange_Cherry, 
                    ymin = logchange_Strawberry-1.96*sd_logchange_Strawberry,
                    ymax = logchange_Strawberry+1.96*sd_logchange_Strawberry),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = EC_Straw_Cher_hypo2, 
                 aes(y=logchange_Strawberry, 
                     xmin = logchange_Cherry-1.96*sd_logchange_Cherry,
                     xmax = logchange_Cherry+1.96*sd_logchange_Cherry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = EC_Straw_Cher_hypo2, 
             aes(x = logchange_Cherry, y = logchange_Strawberry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_StrawChe_G29_HYPO_2


PAIR_CheCran_G29_HYPO_2<-PAIR_CheCran_G29  + 
  geom_errorbar(data = EC_Cran_Cher_hypo2, 
                aes(x=logchange_Cranberry, 
                    ymin = logchange_Cherry-1.96*sd_logchange_Cherry,
                    ymax = logchange_Cherry+1.96*sd_logchange_Cherry),
                width=0.02, size=0.2, alpha=1) + 
  geom_errorbarh(data = EC_Cran_Cher_hypo2, 
                 aes(y=logchange_Cherry, 
                     xmin = logchange_Cranberry-1.96*sd_logchange_Cranberry,
                     xmax = logchange_Cranberry+1.96*sd_logchange_Cranberry),
                 height=0.02, size=0.2, alpha=1) + 
  geom_point(data = EC_Cran_Cher_hypo2, 
             aes(x = logchange_Cranberry, y = logchange_Cherry), 
             shape=21, size=4,  fill = "#ffffff", stroke=1.5)
PAIR_CheCran_G29_HYPO_2



#legend1
legend_tradevide<- ggplot(EC_Cran_Cher_hypo2, aes(x=logchange_Cranberry, 
                                                  y=logchange_Cherry, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  labs(colour = "Population \nevolved on:") + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))

legend_tradevide<-lemon::g_legend(legend_tradevide)

 #legend hypo 1
legend_hypo1<- ggplot(EC_Cran_Cher_hypo2, aes(x=logchange_Cranberry, 
                                                  y=logchange_Cherry, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  labs(colour = "Mean of population\nevolved on:") + 
  geom_point(size=2, shape=21, fill="white", stroke = 2) + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))

extract_legend_hypo1<-lemon::g_legend(legend_hypo1)

 #legend2
legend_hypo2<- ggplot(EC_Cran_Cher_hypo2, aes(x=logchange_Cranberry, 
                                                  y=logchange_Cherry, group=Fruit_s, colour=Fruit_s)) +
  geom_point(size=1.5, position=pd, fill="white", alpha=0.6) + 
  labs(colour = "Population with \nthe highest fitness \non each selection fruit:") + 
  geom_point(size=2, shape=21, fill="white", stroke = 2) + 
  scale_color_manual(values=c("#BC3C6D", "#FDB424","#3FAA96"), 
                     label=c("Cherry","Cranberry", "Strawberry")) +   
  theme_LO_sober +
  theme(legend.title = element_text(colour="black", size=10, face="bold"), 
          legend.text = element_text(colour="black", size=8))
extract_legend_hypo2<-lemon::g_legend(legend_hypo2)




ERRORCROSSES_G7_HYPO1 <- cowplot::ggdraw() +
  cowplot::draw_plot(PAIR_CheCran_G29_HYPO_1+theme(legend.position = "none"), 
            x =0.00, y = 0, width = 0.25, height = 1) +
  cowplot::draw_plot(PAIR_CranStraw_G29_HYPO_1+theme(legend.position = "none"), 
            x = 0.26, y = 0, width = 0.25, height = 1) +
  cowplot::draw_plot(PAIR_StrawChe_G29_HYPO_1+theme(legend.position = "none"), 
            x = 0.52, y = 0, width = 0.25, height = 1) + 
  cowplot::draw_plot(legend_tradevide, x = 0.8, y = 0.73, width = 0.11, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo1, x = 0.83, y = 0.25, width = 0.1, height = 0.1) 
ERRORCROSSES_G7_HYPO1



ERRORCROSSES_G7_HYPO2 <- cowplot::ggdraw() +
  cowplot::draw_plot(PAIR_CheCran_G29_HYPO_2+theme(legend.position = "none"), 
            x =0.00, y = 0, width = 0.25, height = 1) +
  cowplot::draw_plot(PAIR_CranStraw_G29_HYPO_2+theme(legend.position = "none"), 
            x = 0.26, y = 0, width = 0.25, height = 1) +
  cowplot::draw_plot(PAIR_StrawChe_G29_HYPO_2+theme(legend.position = "none"), 
            x = 0.52, y = 0, width = 0.25, height = 1) + 
  cowplot::draw_plot(legend_tradevide, x = 0.78, y = 0.73, width = 0.1, height = 0.1) +
  cowplot::draw_plot(extract_legend_hypo2, x = 0.82, y = 0.25, width = 0.1, height = 0.1) 
ERRORCROSSES_G7_HYPO2








# 
# cowplot::save_plot(file =here::here("figures", "SUPMAT_Pool_Hypothesis1.pdf"),
#                    ERRORCROSSES_G7_HYPO1,
#                    base_height = 7/cm(1), base_width = 28/cm(1), dpi = 610)
# 
# 
# cowplot::save_plot(file =here::here("figures", "SUPMAT_Pool_Hypothesis2.pdf"),
#                    ERRORCROSSES_G7_HYPO2,
#                    base_height = 7/cm(1), base_width = 28/cm(1), dpi = 610)



```





