---
title: "Simulation of log fitness change"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```


# DATA
## Load data
```{r }
## Longitudinal data
data_sum <- loadlongitudinaldata(dataset = "DATA_Adults_G1G29.csv", rm_generation1 = 1,rm_generation2 = 7,rm_generation3 = 29)

## Phenotyping steps
data_G0 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G1")
data_G7 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G7")
data_G29 <- loadfitnessdata(dataset = 
                            "PERFORMANCE_Comptage_adultes_G13G14G15G16G17G18G19G20G21G22G23G24G25G26G27G28G29.csv",
                            generation = "29")
head(data_sum)
head(data_G0)
head(data_G7)
head(data_G29)
dim(data_G29)

## Add line variable
levels(data_G0$Line) <- rep("Anc", nlevels(data_G0$Line))

## Combine datsets
data <- rbind(data_G0, data_G7, data_G29) 
data <- data.frame(Generation = c(rep("0", nrow(data_G0)), rep("7", nrow(data_G7)), rep("29", nrow(data_G29))), data, Obs= as.factor(1:nrow(data)))
head(data)

## New variable for analyses
data$Generation_Fruit_s_Treatment <- as.factor(paste(data$Generation, data$Fruit_s, data$Treatment, sep="_"))
data$Line_Treatment <- as.factor(paste(data$Line, data$Treatment, sep="_"))
data$Treatmentrel <- relevel(data$Treatment, ref="Strawberry")


## Je pense qu'on peut suprimer le code de la ligne 56 à la ligne 83 et utiliser celui des sections suivantes


#Compute log change
## !! sd_logchange are standard errors, not standard deviations
data_logchange <- rbind(computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G7, trait = "Nb_adults", gen=7), computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G29, trait = "Nb_adults", gen=29))

data_logchangeNb_eggs <- rbind(computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G7, trait = "Nb_eggs", gen=7), computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G29, trait = "Nb_eggs", gen=29))

data_logchangeEmergence_rate <- rbind(computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G7, trait = "Emergence_rate", gen=7), computelogchange(fitness_dataset_ancestral = data_G0, fitness_dataset_evolved = data_G29, trait = "Emergence_rate", gen=29))

## Combine datasets
data_logchangeNb_eggsEmergence_rate <- data.frame(data_logchange, Nb_eggslogchange=data_logchangeNb_eggs$logchange, sdNb_eggslogchange=data_logchangeNb_eggs$sd_logchange, Emergence_ratelogchange=data_logchangeEmergence_rate$logchange, sdEmergence_ratelogchange=data_logchangeEmergence_rate$sd_logchange)

#Lines: CE2 and CR2 do not pass Geary's test (the threshold of a standardized mean greater than 3)
data_logchange$Line_type  <- ifelse(data_logchange$Line == "CR2"| data_logchange$Line == "CE2", "solid","dashed")
data_logchangeNb_eggs$Line_type  <- ifelse(data_logchange$Line == "CR2"| data_logchange$Line == "CE2", "solid","dashed")
data_logchangeEmergence_rate$Line_type  <- ifelse(data_logchange$Line == "CR2"| data_logchange$Line == "CE2", "solid","dashed")


#Formatting for testing correlation
TEMP_dataG7_CheCran <- formattinglogchange(data_logchange, "7", "Cherry", "Cranberry")
TEMP_dataG7_CranStraw <- formattinglogchange(data_logchange, "7", "Cranberry", "Strawberry")
TEMP_dataG7_StrawChe <- formattinglogchange(data_logchange, "7", "Strawberry", "Cherry")

TEMP_dataG29_CheCran <- formattinglogchange(data_logchange, "29", "Cherry", "Cranberry")
TEMP_dataG29_CranStraw <- formattinglogchange(data_logchange, "29", "Cranberry", "Strawberry")
TEMP_dataG29_StrawChe <- formattinglogchange(data_logchange, "29", "Strawberry", "Cherry")

```

## Compute fitess change per population
### Small example with a plot of the likelihod difference as a function of each parameter value
```{r }

mfitness <- MASS::glm.nb(Nb_adults ~ Treatment, data=data)
summary(mfitness)

pr1 <- profile(mfitness, alpha = 0.1)

MASS:::plot.profile(pr1)

```

### Fitness
```{r }

mfitness <- MASS::glm.nb(Nb_adults ~ -1 + Treatment + Line:Treatment, data=data)
summary(mfitness)

CIfitness <- confint(mfitness)

pr1 <- profile(mfitness, alpha = 0.1)

pdf(file="figures/Profile.pdf")
MASS:::plot.profile(pr1)
dev.off()
```

### Fecundity
```{r }

mfecundity <- MASS::glm.nb(Nb_eggs ~ -1+Treatment+Line:Treatment, data=data)
summary(mfecundity)

CIfecundity <- confint(mfecundity)

```

### Egg-to-adult viability
```{r }
## 4 tubes with more adults than eggs
sum(data$Nb_adults>data$Nb_eggs)

## Number of adults=number of eggs
data$Nb_eggs[data$Nb_adults>data$Nb_eggs] <- data$Nb_adults[data$Nb_adults>data$Nb_eggs]

## Fit model
megg_to_ad <- glm(cbind(Nb_adults, Nb_eggs) ~ -1+Treatment+Line:Treatment, data=data, family="binomial")
summary(megg_to_ad)

CImegg_to_ad <- confint(megg_to_ad)

```

## Build data_logchange dataset
```{r }
## Extract all CIs
## J'ai garder le nom logchange pour que le code pour la Fig. 4 marche, mais je pense que ça vaudrait le coup que le nom soit plus informatif, comme logfitnesschange par exemple
## Check that the coef are in the same order
identical(names(coef(mfitness)), names(coef(mfecundity)))
identical(names(coef(mfitness)), names(coef(megg_to_ad)))

data_logchange <- data.frame(logchange=coef(mfitness),
                             lowCIlogfitnesschange=CIfitness[, 1],
                             upCIlogfitnesschange=CIfitness[, 2],
                             logfecundchange=coef(mfecundity),
                             lowCIlogfecundchange=CIfecundity[, 1],
                             upCIlogfecundchange=CIfecundity[, 2],
                             logeggtoadchange=coef(megg_to_ad),
                             lowCIlogeggtoadchange=CImegg_to_ad[, 1],
                             upCIlogeggtoadchange=CImegg_to_ad[, 2])
head(data_logchange)

## Remove estimates from ancestral population
data_logchange <- data_logchange[4:nrow(data_logchange), ]
  
## Extract information regarding line, selective and test media
rowname <- strsplit(rownames(data_logchange), split=":")
Treatment <- as.factor(gsub("Treatment", "", lapply(rowname, `[[`, 1)))
Generation <- Line <- as.factor(gsub("Line", "", lapply(rowname, `[[`, 2)))
## Change Fruit_s levels
Fruit_s <- as.factor(substr(Line, 1, 2))
levels(Fruit_s) <- levels(Treatment)
## Change levels
levels(Generation) <- ifelse(is.na(as.numeric(substr(levels(Generation), 3, 3))), "29", "7")

## Combine data
data_info <- data.frame(Treatment, Line, Fruit_s, Generation)
data_info$Line_Treatement <- paste(data_info$Line, data_info$Treatment, sep="_")
# Add symp and allop
data_info$SA <- as.factor(ifelse(data_info$Treatment == data_info$Fruit_s , 1, 0))
data.frame(names(coef(mfitness))[4:length(coef(mfitness))], data_info)

## Compute sample size per line and test medium
sample_size <- aggregate(Nb_eggs~Line:Treatment, length, data=data[data$Generation!="0",])
sample_size$Line_Treatement <- paste(sample_size$Line, sample_size$Treatment, sep="_")
names(sample_size)[3] <- "N"

## Merge the three datasets
data_info <- merge(x=data_info, y=sample_size[, 3:4], by="Line_Treatement")
data_info$Line_Treatment <- paste0("Treatment", data_info$Treatment, ":Line", data_info$Line)
data_logchange$Line_Treatment <- rownames(data_logchange)
data_logchange <- merge(x=data_info, y=data_logchange, by = "Line_Treatment")[, -c(1, 2)]

head(data_logchange)
```


## Build sympatric/allopatric datasets
```{r }
# ## Proposition de fonction simplifiée
# formattinglogchange <- function(logchange_dataset = data_logchange, generation="7", fruitcomb=c("Cherry", "Cranberry")){
# ## Extract sympatric combinations
# TEMP_symp <- data_logchange[data_logchange$Generation==generation&data_logchange$Treatment%in%fruitcomb&data_logchange$Fruit_s%in%fruitcomb&data_logchange$SA==1,]
# names(TEMP_symp)[6:ncol(TEMP_symp)] <- paste0(names(TEMP_symp)[6:ncol(TEMP_symp)], "_symp")
# ## Sort dataset
# TEMP_symp <- TEMP_symp[order(TEMP_symp$Line),]
# 
# ## Extract allopatric combinations
# TEMP_allop <- data_logchange[data_logchange$Generation==generation&data_logchange$Treatment%in%fruitcomb&data_logchange$Fruit_s%in%fruitcomb&data_logchange$SA==0,]
# names(TEMP_allop)[6:ncol(TEMP_allop)] <- paste0(names(TEMP_allop)[6:ncol(TEMP_allop)], "_allop")
# ## Sort dataset
# TEMP_allop <- TEMP_allop[order(TEMP_allop$Line),]
# 
#   ## Combine datasets
#   if(identical(TEMP_symp$Line, TEMP_allop$Line)){
#     TEMP <- data.frame(TEMP_symp[, c(1:4, 6:9)], TEMP_allop[, 6:9])
#     TEMP$N_sumsympallop <- TEMP$N_symp + TEMP$N_allop
#     return(TEMP)
#   }else{
#     print("Error: sympatric and allopatric datasets are not in the same order")
#   }
# 
# }
# 



formattinglogchange <- function(logchange_dataset = data_logchange, generation="7", 
                                          fruitcomb=c("Cherry", "Cranberry"), trait="fecundity"){
## Extract sympatric combinations
TEMP_symp <- logchange_dataset[logchange_dataset$Generation==generation&
                                 logchange_dataset$Treatment%in%fruitcomb&
                                 logchange_dataset$Fruit_s%in%fruitcomb&logchange_dataset$SA==1,]
names(TEMP_symp)[6:ncol(TEMP_symp)] <- paste0(names(TEMP_symp)[6:ncol(TEMP_symp)], "_symp")
## Sort dataset
TEMP_symp <- TEMP_symp[order(TEMP_symp$Line),]

## Extract allopatric combinations
TEMP_allop <- logchange_dataset[logchange_dataset$Generation==generation&
                                  logchange_dataset$Treatment%in%fruitcomb&
                                  logchange_dataset$Fruit_s%in%fruitcomb&logchange_dataset$SA==0,]
names(TEMP_allop)[6:ncol(TEMP_allop)] <- paste0(names(TEMP_allop)[6:ncol(TEMP_allop)], "_allop")
## Sort dataset
TEMP_allop <- TEMP_allop[order(TEMP_allop$Line),]

  ## Combine datasets
if(identical(TEMP_symp$Line, TEMP_allop$Line)){
  if(trait == "fitness"){
    TEMP <- data.frame(TEMP_symp[, c(1:4, 6:9)], TEMP_allop[, 6:9])
    TEMP$N_sumsympallop <- TEMP$N_symp + TEMP$N_allop
  }else{
    if (trait == "fecundity") {
    TEMP <- data.frame(TEMP_symp[, c(1:4, 6, 10:12)], TEMP_allop[, c(6, 10:12)])
    TEMP$N_sumsympallop <- TEMP$N_symp + TEMP$N_allop
    }else{
      if (trait == "eggtoad") {
      TEMP <- data.frame(TEMP_symp[, c(1:4, 6, 13:15)], TEMP_allop[, c(6, 13:15)])
      TEMP$N_sumsympallop <- TEMP$N_symp + TEMP$N_allop
      }else{
      print("Error: trait unknown")
      }
    }
  }

  }else{
    print("Error: sympatric and allopatric datasets are not in the same order")
 }
    
 return(TEMP)
}


#Formatting for testing correlation
TEMP_dataG7_CheCran <- formattinglogchange(logchange_dataset = data_logchange, generation="7", fruitcomb=c("Cherry", "Cranberry"))
TEMP_dataG7_CranStraw <- formattinglogchange(logchange_dataset = data_logchange, generation="7", fruitcomb=c("Strawberry", "Cranberry"))
TEMP_dataG7_StrawChe <- formattinglogchange(logchange_dataset = data_logchange, generation="7", fruitcomb=c("Cherry", "Strawberry"))

TEMP_dataG29_CheCran <- formattinglogchange(logchange_dataset = data_logchange, generation="29", fruitcomb=c("Cherry", "Cranberry"))
TEMP_dataG29_CranStraw <- formattinglogchange(logchange_dataset = data_logchange, generation="29", fruitcomb=c("Strawberry", "Cranberry"))
TEMP_dataG29_StrawChe <- formattinglogchange(logchange_dataset = data_logchange, generation="29", fruitcomb=c("Cherry", "Strawberry"))
```

# ADAPTATION
## Proportion of adaptation: raw data
```{r }

tapply(data_sum$Nb_adults[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)
tapply(data_sum$Nb_adults[data_sum$Generation=="27"],data_sum$Fruit_s[data_sum$Generation=="27"],mean)

## Calcul proportion change between G2 and G27 
((tapply(data_sum$Nb_adults[data_sum$Generation=="27"],data_sum$Fruit_s[data_sum$Generation=="27"],mean) -
    tapply(data_sum$Nb_adults[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)) / 
  tapply(data_sum$Nb_adults[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)) * 100

# 
# (abs(tapply(data_sum$fitness[data_sum$Generation=="27"],data_sum$Fruit_s[data_sum$Generation=="27"],mean) -
#     tapply(data_sum$fitness[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)) / 
#   abs(tapply(data_sum$fitness[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean))) * 100


## Calcul proportion change between G2 and phase2 (because G8 is not representative)  
((tapply(data_sum$Nb_adults[data_sum$Generation=="8"],data_sum$Fruit_s[data_sum$Generation=="8"],mean) -
    tapply(data_sum$Nb_adults[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)) / 
  tapply(data_sum$Nb_adults[data_sum$Generation=="2"],data_sum$Fruit_s[data_sum$Generation=="2"],mean)) * 100


## Compute proportion change between G2 and phase 2 (because G8 is not representative)  
((tapply(data_sum$Nb_adults[data_sum$Phase=="pool"],data_sum$Fruit_s[data_sum$Phase=="pool"],mean) -
    tapply(data_sum$Nb_adults[data_sum$Phase=="first_prepool"],data_sum$Fruit_s[data_sum$Phase=="first_prepool"],mean)) / 
  tapply(data_sum$Nb_adults[data_sum$Phase=="first_prepool"],data_sum$Fruit_s[data_sum$Phase=="first_prepool"],mean)) * 100

((tapply(data_sum$Nb_adults[data_sum$Phase=="second_postpool"],data_sum$Fruit_s[data_sum$Phase=="second_postpool"],mean) -
    tapply(data_sum$Nb_adults[data_sum$Phase=="first_prepool"],data_sum$Fruit_s[data_sum$Phase=="first_prepool"],mean)) / 
  tapply(data_sum$Nb_adults[data_sum$Phase=="first_prepool"],data_sum$Fruit_s[data_sum$Phase=="first_prepool"],mean)) * 100




```


## Analysis
```{r }
######## Models
mod1 <- lme4::lmer(fitness ~ 1 + (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod2 <- lme4::lmer(fitness~ Phase +  (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE)
mod3 <- lme4::lmer(fitness ~ Generation +(1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod4 <- lme4::lmer(fitness ~ Fruit_s + (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod5 <- lme4::lmer(fitness ~ Fruit_s*Phase +  (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod6 <- lme4::lmer(fitness ~ Fruit_s*Generation + (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod7 <- lme4::lmer(fitness ~ Fruit_s + Phase + (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 
mod8 <- lme4::lmer(fitness ~ Fruit_s + Generation +  (1|Generation:Fruit_s), 
            weights = N, data = data_sum, REML = FALSE) 

MuMIn::model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8)

summary(mod7)


mod_Phase <- lme4::lmer(fitness ~ Fruit_s + Phase + (1|Generation:Fruit_s), 
            weights = N, data = data_sum) 


#Posthoc
emmeans::emmeans(mod_Phase, list(pairwise ~ Phase), adjust = "tukey") #

emmeans::emmeans(mod_Phase, list(pairwise ~ Phase+Fruit_s), adjust = "tukey") #


```


## Plot 
```{r }
#Position dodge
pd <- ggplot2::position_dodge(0.3) # move them .05 to the left and right

#Extract slope and intercept
dat_predict_allfruits <- expand.grid(Generation=as.numeric(levels(as.factor(data_sum$Generation))),
                                     Fruit_s=unique(data_sum$Fruit_s))

dat_predict_allfruits$Phase <- ifelse(dat_predict_allfruits$Generation<= 7, "first_prepool",
                                     ifelse(dat_predict_allfruits$Generation>=12, "second_postpool", "pool"))
dat_predict_allfruits$fitness_predicted <- predict(mod_Phase, newdata = dat_predict_allfruits, 
                          re.form= NA, type = "response")

#REAL DATA
#Add G1 G6 and G7
TEMP_lineG1 <- c(rep(NA, 2), 1,rep(NA, 5))
TEMP_lineG6 <- c(rep(NA, 2), 6,rep(NA, 5))
TEMP_lineG7 <- c(rep(NA, 2), 7,rep(NA, 5))

TEMP_total <- rbind(data_sum,TEMP_lineG1,TEMP_lineG1,TEMP_lineG1,TEMP_lineG6,TEMP_lineG6,TEMP_lineG6,TEMP_lineG7,TEMP_lineG7,TEMP_lineG7)
TEMP_total$Fruit_s[TEMP_total$Generation == "6"] <- c("Strawberry", "Cranberry", "Cherry")
TEMP_total$Fruit_s[TEMP_total$Generation == "1"] <- c("Strawberry", "Cranberry", "Cherry")
TEMP_total$Fruit_s[TEMP_total$Generation == "7"] <- c("Strawberry", "Cranberry", "Cherry")
tail(TEMP_total)


## Add label 
TEMP_anno <- data.frame(x1 = c(3.5, 3.5,  10, 3.5,  3.5, 10,  3.5, 3.5, 10), 
                        x2 = c(9, 17.5, 17.5,9, 17.5,  17.5,9,17.5, 17.5),
                        y1 = c(1,2,1.2,1,2,1.2,1,2,1.2), 
                        y2 = c(1.25,  2.25, 1.45, 1.25,  2.25, 1.45,1.25,  2.25, 1.45),
                        xstar = c(6.5,10,14,6.5,10,14,6.5,10,14), 
                        ystar = c(1.5,2.5,1.7,1.5,2.5,1.7,1.5,2.5,1.7),
                        lab = c("**", "***", "**", "**",  "***",  "**", "**" ,"***",  "**"),
                        Fruit_s = c("Cherry", "Cherry", "Cherry",
                               "Cranberry", "Cranberry", "Cranberry",
                               "Strawberry","Strawberry","Strawberry"), 
                        Line = NA)
TEMP_anno




TEMP_title <- data.frame(xtitle = c(14, 14, 14),
                       ytitle = c(3, 3, 3),
                       title = c("Cherry", "Cranberry", "Strawberry"),
                       Fruit_s = c("Cherry", "Cranberry", "Strawberry"), 
                       Line = NA)
TEMP_title


PLOT_FITNESS_CHERRY <- ggplot(data = TEMP_total[TEMP_total$Fruit_s == "Cherry",], 
                            aes(x = factor(Generation),group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin =fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.2,color = "black") + 
  geom_line(size = 0.3,position = pd) + 
  geom_line(data = dat_predict_allfruits[dat_predict_allfruits$Fruit_s == "Cherry",], 
                     aes(x = factor(Generation), y = fitness_predicted,
                         colour = "black", group = Phase), size = 0.5) + 
  geom_point(size =1, position = pd, shape =21, fill = "white") + 
  ylim(-3, 3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s == "Cherry",], aes(x = xstar,  y = ystar, label = lab), size =3.3) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cherry",], aes(x = x1, xend = x1, 
           y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cherry",], aes(x = x2, xend = x2, 
           y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cherry",], aes(x = x1, xend = x2, 
           y = y2, yend = y2), size = 0.4) + 
  scale_color_manual(values = c("black", "#BC3C6D", "#FDB424", "#3FAA96")) + 
  ggtitle("Cherry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#BC3C6D"))
PLOT_FITNESS_CHERRY



PLOT_FITNESS_CRANB <- ggplot2::ggplot(data = TEMP_total[TEMP_total$Fruit_s == "Cranberry",], 
                            aes(x = factor(Generation),group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin =fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.2,color = "black") + 
  geom_line(size = 0.3,position = pd) + 
  geom_line(data = dat_predict_allfruits[dat_predict_allfruits$Fruit_s == "Cranberry",], aes(x = factor(Generation), y = fitness_predicted, colour = "black", group = Phase),
                size = 0.5) + 
  geom_point(size =1, position = pd, shape =21, fill = "white") + 
  ylim(-3, 3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s == "Cranberry",], aes(x = xstar,  y = ystar, label = lab), size =3.3) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cranberry",], aes(x = x1, xend = x1, 
           y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cranberry",], aes(x = x2, xend = x2, 
           y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Cranberry",], aes(x = x1, xend = x2, 
           y = y2, yend = y2), size = 0.4) + 
  scale_color_manual(values = c("black", "#FDB424")) + 
  ggtitle("Cranberry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#FDB424"))
PLOT_FITNESS_CRANB



PLOT_FITNESS_STRAW <- ggplot2::ggplot(data = TEMP_total[TEMP_total$Fruit_s == "Strawberry",], 
                            aes(x = factor(Generation),group = Line, y = fitness, colour =Fruit_s)) + 
  geom_errorbar(aes(ymin =fitness-1.96*se_fitness, ymax = fitness + 1.96*se_fitness),
                width=.1,position = pd, size = 0.2,color = "black") + 
  geom_line(size = 0.3,position = pd) + 
  geom_line(data = dat_predict_allfruits[dat_predict_allfruits$Fruit_s == "Strawberry",], 
            aes(x = factor(Generation), y = fitness_predicted, colour = "black", group = Phase),
            size = 0.5) + 
  geom_point(size =1, position = pd, shape =21, fill = "white") + 
  ylim(-3, 3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s == "Strawberry",], 
            aes(x = xstar,  y = ystar, label = lab), size =3.3) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Strawberry",], 
               aes(x = x1, xend = x1, y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Strawberry",], 
               aes(x = x2, xend = x2, y = y1, yend = y2), size = 0.4) + 
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s == "Strawberry",], 
               aes(x = x1, xend = x2, y = y2, yend = y2), size = 0.4) + 
  scale_color_manual(values = c("black", "#3FAA96")) + 
  ggtitle("Strawberry") + 
  theme_LO_adaptation + theme(plot.title = element_text(color = "#3FAA96"))
PLOT_FITNESS_STRAW


DYNAMIQUE_THREE_JOIN <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_FITNESS_CHERRY + theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()), 
            x = 0, y = 0.66, width = 1, height = 0.33) + 
  cowplot::draw_plot(PLOT_FITNESS_CRANB + theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()), 
            x = 0, y = 0.33, width = 1, height = 0.33) + 
  cowplot::draw_plot(PLOT_FITNESS_STRAW, 
            x = 0, y = 00, width = 1, height = 0.33) + 
  cowplot::draw_plot_label(c("A", "B", "C"),  
                  x = c(0, 0, 0), 
                  y = c(1, 0.66, 0.33), 
                  hjust = c(-0.5, -0.5, -0.5), 
                  vjust = c(1.5, 1.5, 1.5),
                  size = 12) 
 DYNAMIQUE_THREE_JOIN


cowplot::save_plot(file =here::here("figures", "FIG_Adaptation.pdf"), DYNAMIQUE_THREE_JOIN, base_height = 17/cm(1), base_width = 11/cm(1), dpi = 1200)



```

# HETEROGENEITY
## Plot fitness
```{r }
pd <-  position_dodge(width = 0.5)

################### INTERMEDIATE PHENOTYPING

# Re-order levels of Line
data_sum_G7 <- data_logchange[data_logchange$Generation == "7",]
data_sum_G7$Line <- factor(data_sum_G7$Line, levels= c("CE2", "CE1", "CE4", "CE3",
                                                       "CR2", "CR3", "CR5", "CR1", "CR4",
                                                       "FR2", "FR3", "FR5", "FR1", "FR4"))


#Plot: 
symp_allop_g7 <- ggplot(data = data_sum_G7, 
                      aes(x = Line, y = logchange, group = Treatment, 
                          color = Fruit_s, shape = Treatment, fill = Fruit_s)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
  geom_errorbar(aes(ymin = lowCIlogfitnesschange, 
                    ymax = upCIlogfitnesschange),
                  width = 0.2, size = 0.5, alpha = 0.6,position = pd) + 
  geom_point(position = pd, fill = "white", size =3) + 
  ylab("Fitness change between intermediate\nand initial phenotyping steps")  + 
  xlab("Populations") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  guides(color = FALSE,
           shape = guide_legend(override.aes = list(fill = c("black")))) + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  theme_LO_sober + theme(axis.text.x  = element_blank()) +
  coord_cartesian(expand = FALSE, ylim = c(-2.7, 2.7), xlim=c(0, 15),clip = "off") + 
  ggtitle("Intermediate phenotyping step") + 
  annotate("text", x = 2.5, y = 2.4, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 7.5, y = 2.4, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 12.5, y = 2.4, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE) + 
  geom_segment(x = 15.5, y = -0.1, xend= 15.5, yend = -1.6, size = 0.15, 
               arrow = arrow(length = unit(0.05, "npc")),colour = "black") + 
  geom_segment(x = 15.5, y = 0.1, xend= 15.5, yend = 1.6, size = 0.15,
               arrow = arrow(length = unit(0.05, "npc")),colour = "black") + 
  annotate("text", x = 16.2, y = 0.7, label = 'bold(" Fitness\nincrease")',
             size = 3,colour = "black", parse = TRUE, angle =90) + 
  annotate("text", x = 16.2, y =-0.7, label = 'bold("  Fitness\ndecrease")',
              size = 3,colour = "black", parse = TRUE, angle =90) 
symp_allop_g7

################### FINAL PHENOTYPING

# Re-order levels of Line
data_sum_G29 <- data_logchange[data_logchange$Generation == "29",]
data_sum_G29$Line <- factor(data_sum_G29$Line, levels = c("CEA", "CEB", "CEC", 
                                                          "CRD", "CRA", "CRC", "CRB", "CRE",
                                                          "FRA", "FRC", "FRB"))

symp_allop_G29 <- ggplot(data = data_sum_G29, 
              aes(x = Line, y=logchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
      geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
    geom_point(size =3, position = pd) + 
    geom_errorbar(aes(ymin =  lowCIlogfitnesschange,
                      ymax = upCIlogfitnesschange),
                width= 0.2, size = 0.5, alpha = 0.6,position = pd) + 
    ylab("Fitness change between final\nand initial phenotyping steps")  + 
    xlab("Populations") + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    guides(fill = FALSE, alpha = FALSE) + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + theme(axis.text.x  = element_blank()) +
    coord_cartesian(expand = FALSE, ylim = c(-2, 2), xlim=c(0, 11),clip = "off") + 
  annotate("text", x = 2, y =1.5, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 6, y =1.5, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 10, y =1.5, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE) + 
  geom_segment(x = 11.5, y = -0.1, xend= 11.5, yend = -1.2, size = 0.15, 
               arrow = arrow(length = unit(0.05, "npc")),colour = "black") + 
    geom_segment(x = 11.5, y = 0.1, xend= 11.5, yend = 1.2, size = 0.15,
               arrow = arrow(length = unit(0.05, "npc")),colour = "black") + 
    annotate("text", x = 12, y = 0.5, label = 'bold(" Fitness\nincrease")',
             size =3,colour = "black",parse = TRUE, angle =90) + 
    annotate("text", x = 12, y = -0.5, label = 'bold("  Fitness\ndecrease")',
              size =3,colour = "black", parse = TRUE, angle =90) + 
  ggtitle("Final phenotyping step") 
symp_allop_G29




### Add stroke
DIF_FITNESS_G7 <- symp_allop_g7 + 
  geom_point(aes(alpha = SA, color = interaction(SA, Fruit_s)), 
             position = pd, size =3, stroke = 1.5, fill = "white") + 
  scale_alpha_manual(values = c(0, 1)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", 
                                "#7C2748", "#CA8702", "#328677", 
                                "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_FITNESS_G7

DIF_FITNESS_G29 <- symp_allop_G29 + geom_point(aes(alpha = SA, color = interaction(SA,Fruit_s)), position = pd, size =3, stroke =1.5) + 
      scale_alpha_manual(values = c(0, 1)) + 
      scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", "#7C2748", "#CA8702", "#328677", "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_FITNESS_G29


plot_legend <- ggplot(data = data_logchange, aes(x = Line, y=logchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
    geom_point(size =3, position = pd) + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + 
    guides(fill = FALSE) + 
    theme(legend.key.size = unit(0.5, "cm"),
        axis.text.x  = element_blank()) +
    coord_cartesian(expand = FALSE, ylim = c(-2, 2), xlim=c(0, 11),clip = "off") 


###########################################################
#############################################ALL PLOT
legend_trade <- lemon::g_legend(plot_legend)
    

SYMP_ALLOP_TOTAL <- cowplot::ggdraw() + 
  cowplot::draw_plot(DIF_FITNESS_G7 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")),
            x = 0, y = 0.5, width = 1, height = 0.5) + 
  cowplot::draw_plot(DIF_FITNESS_G29 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")), 
            x = 0, y = 0, width = 1, height = 0.5) + 
  cowplot::draw_plot_label(c("A", "B"),  
                  x = c(0, 0), y = c(1, 0.5), 
                  size = 14) + 
  cowplot::draw_plot(legend_trade, x = 0.93, y = 0.5, width = 0.001, height = 0.001) 

SYMP_ALLOP_TOTAL


cowplot::save_plot(file =here::here("figures", "FIG_Heterogeneity.pdf"),  
                   SYMP_ALLOP_TOTAL, base_height = 20/cm(1), base_width = 25/cm(1), dpi = 1200)

```

## Plot fecundity
```{r }
pd <-  position_dodge(width = 0.5)

################### INTERMEDIATE PHENOTYPING
symp_allop_g7_FECUNDITY <- ggplot(data = data_sum_G7, 
                      aes(x = Line, y = logfecundchange, group = Treatment, 
                          color = Fruit_s, shape = Treatment, fill = Fruit_s)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
  geom_errorbar(aes(ymin = lowCIlogfecundchange, 
                    ymax = upCIlogfecundchange, linetype = "dashed"),
                  width = 0.2, size = 0.5, alpha = 0.6, position = pd) + 
  geom_point(position = pd, fill = "white", size =3) + 
  ylab("Change in log fecundity between\nintermediate and initial phenotyping steps")  + 
  xlab("Populations") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  guides(color = FALSE,
           shape = guide_legend(override.aes = list(fill = c("black")))) + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  theme_LO_sober + theme(axis.text.x  = element_blank()) +
  coord_cartesian(expand = FALSE, ylim = c(-1.1, 2), xlim=c(0, 15),clip = "off") + 
  ggtitle("Intermediate phenotyping step")  +
  annotate("text", x = 2.5, y = 1.8, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 7.5, y = 1.8, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 12.5, y = 1.8, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE)
symp_allop_g7_FECUNDITY

################### FINAL PHENOTYPING
symp_allop_G29_FECUNDITY <- ggplot(data = data_sum_G29, 
              aes(x = Line, y=logfecundchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
      geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
    geom_point(size =3, position = pd) + 
    geom_errorbar(aes(ymin =lowCIlogfecundchange, ymax =upCIlogfecundchange),
                width= 0.2, size = 0.5, alpha = 0.6,position = pd) + 
    ylab("Change in log fecundity between\nfinal and initial phenotyping steps")  + 
    xlab("Populations") + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    guides(fill = FALSE, alpha = FALSE) + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + theme(axis.text.x  = element_blank()) +
  coord_cartesian(expand = FALSE, ylim = c(-1.1, 2), xlim=c(0, 11),clip = "off") + 
  annotate("text", x = 2, y = 1.4, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 6, y = 1.4, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 10, y = 1.4, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE) +
  ggtitle("Final phenotyping step") 
symp_allop_G29_FECUNDITY


  
### Add stroke
DIF_FECUNDITY_G7 <- symp_allop_g7_FECUNDITY + 
  geom_point(aes(alpha = SA, color = interaction(SA, Fruit_s)), position = pd, size =3, stroke =1.5, fill = "white") + 
  scale_alpha_manual(values = c(0, 1)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", "#7C2748", "#CA8702", "#328677", "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_FECUNDITY_G7

DIF_FECUNDITY_G29 <- symp_allop_G29_FECUNDITY + 
  geom_point(aes(alpha = SA, color = interaction(SA,Fruit_s)), 
             position = pd, size =3, stroke =1.5) + 
      scale_alpha_manual(values = c(0, 1)) + 
      scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", "#7C2748", "#CA8702", "#328677", "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_FECUNDITY_G29


plot_legend <- ggplot(data = data_logchange, aes(x = Line, y=logchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
    geom_point(size =3, position = pd) + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + 
    guides(fill = FALSE) + 
    theme(legend.key.size = unit(0.5, "cm"),
        axis.text.x  = element_blank()) +
    coord_cartesian(expand = FALSE, ylim = c(-2, 2), xlim=c(0, 11),clip = "off") 


###########################################################
#############################################ALL PLOT
legend_trade <- lemon::g_legend(plot_legend)
    

SYMP_ALLOP_TOTAL_FEC <- cowplot::ggdraw() + 
  cowplot::draw_plot(DIF_FECUNDITY_G7 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")),
            x = 0, y = 0.5, width = 1, height = 0.5) + 
  cowplot::draw_plot(DIF_FECUNDITY_G29 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")), 
            x = 0, y = 0, width = 1, height = 0.5) + 
  cowplot::draw_plot_label(c("A", "B"),  
                  x = c(0, 0), y = c(1, 0.5), 
                  size = 14) + 
  cowplot::draw_plot(legend_trade, x = 0.93, y = 0.5, width = 0.001, height = 0.001) 
# 
# cowplot::save_plot(file =here::here("figures", "FIG_SX_HeterogeneityNb_eggs.pdf"),  
#                    SYMP_ALLOP_TOTAL_FEC, base_height = 20/cm(1), base_width = 25/cm(1), dpi = 1200)

```

## Plot egg-to-adult viability
```{r }
pd <-  position_dodge(width = 0.5)



################### INTERMEDIATE PHENOTYPING
symp_allop_g7_VIABILITIY <- ggplot(data = data_sum_G7, 
                      aes(x = Line, y = logeggtoadchange, group = Treatment, 
                          color = Fruit_s, shape = Treatment, fill = Fruit_s)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
  geom_errorbar(aes(ymin = lowCIlogeggtoadchange, 
                    ymax =upCIlogeggtoadchange, linetype = "dashed"),
                  width = 0.2, size = 0.5, alpha = 0.6,position = pd) + 
  geom_point(position = pd, fill = "white", size =3) + 
  ylab("Change in logit egg-to-adult viability\nbetween intermediate and initial phenotyping steps")  + 
  xlab("Populations") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  guides(color = FALSE,
           shape = guide_legend(override.aes = list(fill = c("black")))) + 
  scale_shape_manual(values = c(21, 22, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
  theme_LO_sober + theme(axis.text.x  = element_blank()) +
  coord_cartesian(expand = FALSE, ylim = c(-1.7, 1.6), xlim=c(0, 15),clip = "off") + 
  ggtitle("Intermediate phenotyping step") + 
  annotate("text", x = 2.5, y = 1.4, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 7.5, y = 1.4, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 12.5, y = 1.4, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE)
symp_allop_g7_VIABILITIY

################### FINAL PHENOTYPING
symp_allop_G29_VIABILITIY <- ggplot(data = data_sum_G29, 
              aes(x = Line, y=logeggtoadchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
      geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5) + 
    geom_point(size =3, position = pd) + 
    geom_errorbar(aes(ymin =lowCIlogeggtoadchange, ymax =upCIlogeggtoadchange),
                width= 0.2, size = 0.5, alpha = 0.6,position = pd) + 
    ylab("Change in logit egg-to-adult viability\nbetween final and initial phenotyping steps")  + 
    xlab("Populations") + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    guides(fill = FALSE, alpha = FALSE) + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    scale_fill_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + theme(axis.text.x  = element_blank()) +
    coord_cartesian(expand = FALSE, ylim = c(-1.7, 1.6), xlim=c(0, 11),clip = "off") + 
  annotate("text", x = 2, y = 1.4, label = 'bold(" Evolved\non cherry")',
                     size =3,colour = "#BC3C6D",parse = TRUE) + 
  annotate("text", x = 6, y = 1.4, label = 'bold("   Evolved\non cranberry")',
                     size =3,colour = "#FDB424",parse = TRUE) + 
  annotate("text", x = 10, y = 1.4, label = 'bold("   Evolved\non strawberry")',
                     size =3,colour = "#3FAA96",parse = TRUE) + 
  ggtitle("Final phenotyping step") 
symp_allop_G29_VIABILITIY



### Add stroke
DIF_VIABILITY_G7 <- symp_allop_g7_VIABILITIY + 
  geom_point(aes(alpha = SA, color = interaction(SA,Fruit_s)), position = pd, size =3, stroke =1.5, fill = "white") + 
  scale_alpha_manual(values = c(0, 1)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", "#7C2748", "#CA8702", "#328677", "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_VIABILITY_G7

DIF_VIABILITY_G29 <- symp_allop_G29_VIABILITIY + 
  geom_point(aes(alpha = SA, color = interaction(SA,Fruit_s)), 
             position = pd, size =3, stroke =1.5) + 
      scale_alpha_manual(values = c(0, 1)) + 
      scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96", "#7C2748", "#CA8702", "#328677", "#BC3C6D", "#FDB424", "#3FAA96"))  
DIF_VIABILITY_G29


plot_legend <- ggplot(data = data_logchange, aes(x = Line, y=logchange, group = Treatment, 
                  color =Fruit_s, shape = Treatment,fill =Fruit_s)) + 
    geom_point(size =3, position = pd) + 
    labs(shape = "Test fruit", color = "Selection fruit") + 
    scale_shape_manual(values = c(21, 22, 24)) + 
    scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96")) + 
    theme_LO_sober + 
    guides(fill = FALSE) + 
    theme(legend.key.size = unit(0.5, "cm"),
        axis.text.x  = element_blank()) +
    coord_cartesian(expand = FALSE, ylim = c(-2, 2), xlim=c(0, 11),clip = "off") 


###########################################################
#############################################ALL PLOT
legend_trade <- lemon::g_legend(plot_legend)
    

SYMP_ALLOP_TOTAL_VIABILITY <- cowplot::ggdraw() + 
  cowplot::draw_plot(DIF_VIABILITY_G7 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")),
            x = 0, y = 0.5, width = 1, height = 0.5) + 
  cowplot::draw_plot(DIF_VIABILITY_G29 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")), 
            x = 0, y = 0, width = 1, height = 0.5) + 
  cowplot::draw_plot_label(c("A", "B"),  
                  x = c(0, 0), y = c(1, 0.5), 
                  size = 14) + 
  cowplot::draw_plot(legend_trade, x = 0.93, y = 0.5, width = 0.001, height = 0.001) 

SYMP_ALLOP_TOTAL_VIABILITY


# cowplot::save_plot(file =here::here("figures", "FIG_SX_HeterogeneityEgg-to-adultviability.pdf"),  
#                    SYMP_ALLOP_TOTAL_VIABILITY, base_height = 20/cm(1), base_width = 25/cm(1), dpi = 1200)


#################### ALL SUPPLEMENTS: Fecundity and Viability
DIF_SYMP_ALLOP_TOTAL_SUPPLEMENTS <- cowplot::ggdraw() + 
  cowplot::draw_plot(DIF_FECUNDITY_G7 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")),
            x = 0, y = 0.45, width = 0.55, height = 0.5) + 
  cowplot::draw_plot(DIF_FECUNDITY_G29 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")), 
            x = 0, y = 0, width = 0.55, height = 0.5) + 
  cowplot::draw_plot(DIF_VIABILITY_G7 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")),
            x = 0.45, y = 0.45, width = 0.55, height = 0.5) + 
  cowplot::draw_plot(DIF_VIABILITY_G29 + theme(legend.position = 'none', 
                             plot.margin =unit(c(0.5, 3.5, 0.5, 0.5), "cm")), 
            x = 0.45, y = 0, width = 0.55, height = 0.5) + 
  cowplot::draw_plot_label(c("A", "Fecundity", "B", "Egg-to-adult viability"),  
                  x = c(0, 0.15, 0.45, 0.53), y = c(1, 1, 1, 1), 
                  size = c(17, 15, 17, 15)) + 
  cowplot::draw_plot(legend_trade, x = 0.94, y = 0.5, width = 0.001, height = 0.001) 
DIF_SYMP_ALLOP_TOTAL_SUPPLEMENTS

cowplot::save_plot(file =here::here("figures", "FIG_SX_Heterogeneity_Fecundity_Viability.pdf"),  
                   DIF_SYMP_ALLOP_TOTAL_SUPPLEMENTS, 
                   base_height = 20/cm(1), base_width = 30/cm(1), dpi = 1200)

```


## Analysis fitness
### Compare fit of Poisson lognormal and negative binomial distributions
```{r }
## Poisson lognormal model
mpoislognormal <- lme4::glmer(Nb_adults ~ Generation*Fruit_s*Treatment + (1|Obs), family="poisson", data=data)
summary(mpoislognormal)

## Check convergence
derivs1 <- mpoislognormal@optinfo$derivs
sc_grad1 <- with(derivs1,solve(Hessian,gradient))
max(abs(sc_grad1))

## Negative binomial model
mnegbin <- MASS::glm.nb(Nb_adults ~ Generation*Fruit_s*Treatment, data=data)

## Compare AIC
AIC(mnegbin, mpoislognormal)


## Simulate data with Poisson lognormal distribution
x.teo.poislognormal <- unlist(simulate(mpoislognormal))
x.teo.negbin <- unlist(simulate(mnegbin))


## QQplot to compared Negative binomial and Poisson log normal distributions
qqplot(data$Nb_adults, x.teo.negbin, main="QQ-plot", xlab="Observed data", ylab="Simulated data", las=1, xlim = c(0, 100), ylim = c(0, 100)) ## QQ-plot
points(sort(data$Nb_adults), sort(x.teo.poislognormal), pch=1, col='red')
abline(0,1)
## Add legend
legend(0, 70, legend=c("Neg. Bin.", "Pois. Lognormal"), col=c("black", "red"), pch=1, bty="n")

## Negative binomial distribution provides a better fit to the data
```

### Compare average fitess changes
```{r }
m0 <- MASS::glm.nb(Nb_adults ~ Generation*Fruit_s, data=data)
summary(m0)
## G7: fitness increase for strawberry populations, fitness increased for cherry and cranberry populations
## G29: fitness increase for strawberry populations, no fitness change for cherry and cranberry populations

m1 <- MASS::glm.nb(Nb_adults ~ -1 + Generation_Fruit_s_Treatment, data=data)
summary(m1)
## G0: no difference among different fruit media
## G7: fitness increase for strawberry populations on strawberry, but not on cherry or cranberry fruit media
## G7: no fitness change for cherry or cranberry populations

## G29: fitness increase for cherry populations on cherry medium, but not on strawberry or cranberry medium
## G29: fitness increase for strawberry populations on strawberry medium, but no change on cranberry medium and fitness decrease on cherry medium
## G29: fitness increase for cranberry populations on cranberry and cherry media, and fitness decrease on strawberry medium
library(lme4)
m2 <- lme4::glmer.nb(Nb_adults ~ -1 + Generation_Fruit_s_Treatment + (1|Line), data = data, verbose=TRUE)
summary(m2)
MuMIn::model.sel(m0, m1, m2)

## Get overdispersion parameter
getME(m2, "glmer.nb.theta")

## Check residuals for the different experimental populations
plot(m2, resid(.) ~ as.numeric(Line))

## Check random effect
sjPlot::plot_model(m2, type="re", dot.size=1.5, 
                   group.terms = c(1, rep(2, nlevels(data_G7$Line)), 
                                   rep(3, nlevels(data_G29$Line))))

mySumm <- function(.) {
    c(beta=c(fixef(.)[1:3], fixef(.)[13:21] - rep(fixef(.)[1:3], 3), fixef(.)[4:12] - rep(fixef(.)[1:3], 3)), sigma=sqrt(unlist(VarCorr(.))))
}

boo01 <- lme4::bootMer(m2, mySumm, nsim = 500, re.form = NA)

head(data.frame(boo01))

## Extract all CIs
bCI_tab(boo01)
## G0: no difference among different fruit media (beta.TreatmentrelCherry / beta.TreatmentrelCranberry include zero)
## G7: no fitness change for strawberry, cherry or cranberry populations
## G29: fitness increase for cherry populations on cherry medium, but not on strawberry or cranberry medium

## G29: fitness increase for cranberry populations on cranberry and cherry media, and fitness decrease on strawberry medium
## G29: strawberry population with no change on strawberry or cranberry medium and fitness decrease on cherry medium

# BACKUP
# mfitness_fruits <- lme4::glmer.nb(Nb_adults ~ -1 + Treatment + Fruit_s:Treatment:Generation 
#                                   +  (1|Line), data=data)
# summary(mfitness_fruits)
# CIfitness <- confint(mfitness_fruits)

```

## Analysis fecundity
### Compare fit of Poisson lognormal and negative binomial distributions
```{r }
## Poisson lognormal model
mpoislognormal <- lme4::glmer(Nb_eggs ~ Generation*Fruit_s*Treatment + (1|Obs), family="poisson", data=data)
summary(mpoislognormal)

## Check convergence
derivs1 <- mpoislognormal@optinfo$derivs
sc_grad1 <- with(derivs1,solve(Hessian,gradient))
max(abs(sc_grad1))

## Negative binomial model
mnegbin <- MASS::glm.nb(Nb_eggs ~ Generation*Fruit_s*Treatment, data=data)

## Compare AIC
AIC(mnegbin, mpoislognormal)


## Simulate data with Poisson lognormal distribution
x.teo.poislognormal <- unlist(simulate(mpoislognormal))
x.teo.negbin <- unlist(simulate(mnegbin))


## QQplot to compared Negative binomial and Poisson log normal distributions
qqplot(data$Nb_eggs, x.teo.negbin, main="QQ-plot", xlab="Observed data", ylab="Simulated data", las=1, xlim = c(0, 100), ylim = c(0, 100)) ## QQ-plot
points(sort(data$Nb_eggs), sort(x.teo.poislognormal), pch=1, col='red')
abline(0,1)
## Add legend
legend(0, 70, legend=c("Neg. Bin.", "Pois. Lognormal"), col=c("black", "red"), pch=1, bty="n")

## Negative binomial distribution provides a better fit to the data
```
### Compare changes in fecundity
```{r }

m0 <- MASS::glm.nb(Nb_eggs ~ Generation*Fruit_s, data=data)
summary(m0)

m1 <- MASS::glm.nb(Nb_eggs ~ -1 + Generation_Fruit_s_Treatment, data=data)
summary(m1)

m2 <- lme4::glmer.nb(Nb_eggs ~ -1 + Generation_Fruit_s_Treatment + (1|Line), data = data, verbose=TRUE)
summary(m2)

MuMIn::model.sel(m0, m1, m2)

m3 <- lme4::glmer.nb(Nb_eggs ~ Generation*Fruit_s*Treatmentrel + (1|Line), data = data, verbose=TRUE)
summary(m3)

## Get overdispersion parameter
getME(m2, "glmer.nb.theta")

## Check residuals for the different experimental populations
plot(m2, resid(.) ~ as.numeric(Line))

boo01 <- lme4::bootMer(m2, mySumm, nsim = 50, re.form = NA)

head(data.frame(boo01))

## Extract CI
bCI_tab(boo01)

## G0: no difference among different fruit media (beta.TreatmentrelCherry / beta.TreatmentrelCranberry include zero)
## G7: no fitness change for strawberry, cherry or cranberry populations

## G29: fitness increase for cherry populations on cherry and cranberry medium, but not on strawberry medium

## G29: fitness increase for cranberry populations on cranberry and cherry media, and fitness decrease on strawberry medium

## G29: strawberry population with no change on strawberry or cranberry medium and fitness decrease on cherry medium
```

## Analysis egg-to-adult viability

```{r }
head(data)



m0 <- glm(cbind(Nb_adults, Nb_eggs) ~ Generation*Fruit_s, data=data, family="binomial")
summary(m0)

m1 <- glm(cbind(Nb_adults, Nb_eggs) ~ -1 + Generation_Fruit_s_Treatment, data=data, family="binomial")
summary(m1)

m2 <- lme4::glmer(cbind(Nb_adults, Nb_eggs) ~ -1 + Generation_Fruit_s_Treatment + (1|Line), data = data, verbose=TRUE, family="binomial")
summary(m2)
MuMIn::model.sel(m0, m1, m2)

## Check residuals for the different experimental populations
plot(m2, resid(.) ~ as.numeric(Line))

boo01 <- lme4::bootMer(m2, mySumm, nsim = 500, re.form = NA)

head(data.frame(boo01))

## Extract CI
bCI_tab(boo01)

## G0: no difference among different fruit media (beta.TreatmentrelCherry / beta.TreatmentrelCranberry include zero)
## G7: no fitness change for strawberry, cherry or cranberry populations

## G29: fitness increase for cherry populations on cherry and cranberry medium, but not on strawberry medium

## G29: fitness increase for cranberry populations on cranberry and cherry media, and fitness decrease on strawberry medium

## G29: strawberry population with no change on strawberry or cranberry medium and fitness decrease on cherry medium


m3 <- lme4::glmer(cbind(Nb_adults, Nb_eggs) ~ -1 + Generation*Fruit_s*Treatmentrel + (1|Line), data = data, verbose=TRUE, family="binomial")

summary(m3)
```
# CORRELATED RESPONSES 
## Analysis MA and correlation
```{r}

# ##### Create empty dataframe with slopes and confidence interval for all pairwise
Estimates_pairwise <- data.frame(Variables = rep(rep(c("correlation","cor_CI_inf","cor_CI_sup",
                                                       "slope", "intercept"),2),3),
                                 Generation = rep(c(rep(7, 5), rep(29, 5)),3),
                                 Pairwise = rep(c("Cherry_Cranberry",
                                                     "Cranberry_Strawberry", 
                                                     "Strawberry_Cherry"), each=10),
                                Estimates = NA)



fillout_estimate_correlation <- function(emptydata = Estimates_pairwise, gen = 7, pair = "Cherry_Cranberry") {
emptydata$Estimates[emptydata$Generation == gen & 
                            emptydata$Pairwise == pair &
                              emptydata$Variables=="correlation"] <- weightedcor$estimate
emptydata$Estimates[emptydata$Generation == gen & 
                            emptydata$Pairwise == pair &
                              emptydata$Variables=="cor_CI_inf"] <- weightedcor$ci[1]
emptydata$Estimates[emptydata$Generation == gen & 
                            emptydata$Pairwise == pair &
                              emptydata$Variables=="cor_CI_sup"] <- weightedcor$ci[2]
emptydata$Estimates[emptydata$Generation == gen & 
                            emptydata$Pairwise == pair &
                              emptydata$Variables=="intercept"] <- model$regression.results[2, 2]
emptydata$Estimates[emptydata$Generation == gen & 
                            emptydata$Pairwise == pair &
                              emptydata$Variables=="slope"] <- model$regression.results[2, 3]

return (emptydata)
}

#########################
######################### G7
#########################

####### 
#######  Cherry Cranberry
####### 

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG7_CheCran, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## With cor.tes, the estimation of correlation coefficient is right, but the confidence interval is wrong
cor.test(x=TEMP_dataG7_CheCran[rep(1:nrow(TEMP_dataG7_CheCran), TEMP_dataG7_CheCran$N_sumsympallop), "logchange_symp"], y=TEMP_dataG7_CheCran[rep(1:nrow(TEMP_dataG7_CheCran), TEMP_dataG7_CheCran$N_sumsympallop), "logchange_allop"])

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG7_CheCran[rep(1:nrow(TEMP_dataG7_CheCran), TEMP_dataG7_CheCran$N_sumsympallop),], nperm=0)

# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 7, "Cherry_Cranberry")


####### 
#######  Cranberry Strawberry
####### 

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG7_CranStraw, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG7_CranStraw[rep(1:nrow(TEMP_dataG7_CranStraw), TEMP_dataG7_CranStraw$N_sumsympallop),], nperm=0)


# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 7, "Cranberry_Strawberry")


####### 
#######  Strawberry  Cherry
####### 

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG7_StrawChe, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG7_StrawChe[rep(1:nrow(TEMP_dataG7_StrawChe), TEMP_dataG7_StrawChe$N_sumsympallop),], nperm=0)

# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 7, "Strawberry_Cherry")


#########################
######################### G29
######################### 


####### 
#######  Cherry Cranberry
####### 


## Compute unweighted correlation
unweightedcor <- cor.test(x=TEMP_dataG29_CheCran$logchange_symp, y=TEMP_dataG29_CheCran$logchange_allop)

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG29_CheCran, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG29_CheCran[rep(1:nrow(TEMP_dataG29_CheCran), TEMP_dataG29_CheCran$N_sumsympallop),], nperm=0)

# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 29, "Cherry_Cranberry")


####### 
#######  Cranberry Strawberry
####### 

## Compute unweighted correlation
unweightedcor <- cor.test(x=TEMP_dataG29_CranStraw$logchange_symp, y=TEMP_dataG29_CranStraw$logchange_allop)

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG29_CranStraw, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG29_CranStraw[rep(1:nrow(TEMP_dataG29_CranStraw), TEMP_dataG29_CranStraw$N_sumsympallop),], nperm=0)


# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 29, "Cranberry_Strawberry")


####### 
#######  Strawberry  Cherry
####### 

## Compute unweighted correlation
unweightedcor <- cor.test(x=TEMP_dataG29_StrawChe$logchange_symp, y=TEMP_dataG29_StrawChe$logchange_allop)

## Compute weighted correlation
weightedcor <- sjstats:::weighted_correlation(TEMP_dataG29_StrawChe, x=logchange_symp, y=logchange_allop, weights=N_sumsympallop, ci.lvl = 0.95)

## Compute Major Axis regression
model <- lmodel2::lmodel2(logchange_allop ~ logchange_symp,
                            range.y = "interval",range.x = "interval",
                            data = TEMP_dataG29_StrawChe[rep(1:nrow(TEMP_dataG29_StrawChe), TEMP_dataG29_StrawChe$N_sumsympallop),], nperm=0)

# Fill in data
Estimates_pairwise <- fillout_estimate_correlation (Estimates_pairwise, 29, "Strawberry_Cherry")


## Some estimates are outside [-1, 1]
Estimates_pairwise[Estimates_pairwise$Variables=="cor_CI_inf",]
Estimates_pairwise[Estimates_pairwise$Variables=="cor_CI_sup",]

## Change the estimate to the boundary
Estimates_pairwise$Estimates[Estimates_pairwise$Variables=="cor_CI_inf"&Estimates_pairwise$Estimates<(-1)] <- rep(-1, sum(Estimates_pairwise$Variables=="cor_CI_inf"&Estimates_pairwise$Estimates<(-1)))

Estimates_pairwise$Estimates[Estimates_pairwise$Variables=="cor_CI_sup"&Estimates_pairwise$Estimates > 1] <- rep(1, sum(Estimates_pairwise$Variables=="cor_CI_sup"&Estimates_pairwise$Estimates > 1))

```

## Compute confidence interval of the difference
```{r}

computeCIcordifG7G29(pair="Cherry_Cranberry")
computeCIcordifG7G29(pair="Cranberry_Strawberry")
computeCIcordifG7G29(pair="Strawberry_Cherry")

```

## Plot Fitness
```{r } 
ymin = -50
ymax = 50


## Function equation R
eq_r <- function(gen = 7, pair = "Cherry_Cranberry") {
  if(gen == 7 &pair == "Cherry_Cranberry"){
            as.character(
      as.expression(
        substitute(~~italic(rho)~"="~r2~"["~inf~","~sup~"]",
                  list(r2 = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
  Estimates_pairwise$Pairwise == pair &
  Estimates_pairwise$Variables == "correlation"], digits = 2), 
                  inf = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
  Estimates_pairwise$Pairwise == pair &
  Estimates_pairwise$Variables == "cor_CI_inf"], digits = 1, nsmall=2), 
                  sup = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
  Estimates_pairwise$Pairwise == pair &
  Estimates_pairwise$Variables == "cor_CI_sup"], digits = 2)))
      )
    )
      

  }else{
      as.character(
    as.expression(
      substitute(~~italic(rho)~"="~r2~"["~inf~","~sup~"]",
                list(r2 = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
Estimates_pairwise$Pairwise == pair &
Estimates_pairwise$Variables == "correlation"], digits = 2), 
                inf = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
Estimates_pairwise$Pairwise == pair &
Estimates_pairwise$Variables == "cor_CI_inf"], digits = 2, nsmall=2), 
                sup = format(Estimates_pairwise$Estimates[Estimates_pairwise$Generation == gen &
Estimates_pairwise$Pairwise == pair &
Estimates_pairwise$Variables == "cor_CI_sup"], digits = 2)))
    )
  )
  }

}



##################################################
##################   G7
# Limits
ymin_CheCranG7=min(min(TEMP_dataG7_CheCran$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CheCran$lowCIlogfitnesschange_symp, na.rm= TRUE)) 
ymax_CheCranG7=max(max(TEMP_dataG7_CheCran$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CheCran$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-2



# Plot
CheCran_G7 <- ggplot(data = TEMP_dataG7_CheCran) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_text(x = 0, y = 2, 
            label = eq_r(gen = 7, pair = "Cherry_Cranberry"), parse = TRUE, 
            color="black", size = 3.5) +
  geom_errorbar(aes(x = logchange_symp, ymin = lowCIlogfitnesschange_allop,
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logchange_symp, y = logchange_allop,  
                 color = Fruit_s,fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  theme_LO_sober + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG7, ymax_CheCranG7), 
                  xlim = c(ymin_CheCranG7, ymax_CheCranG7)) 
  
 CheCran_G7


# Limits
ymin_CranStrawG7=min(min(TEMP_dataG7_CranStraw$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CranStraw$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CranStrawG7=max(max(TEMP_dataG7_CranStraw$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CranStraw$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG7+0.99*(ymax_CranStrawG7-ymin_CranStrawG7)


CranStraw_G7 <-  ggplot(data = TEMP_dataG7_CranStraw) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x = logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_allop, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  color = Fruit_s,
                 fill = Fruit_s, shape = Treatment),
                   size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.25, y = lim_text, label = eq_r(gen = 7, pair = "Cranberry_Strawberry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
     ggtitle("Cranberry vs. Strawberry") + 
  coord_cartesian(ylim = c(ymin_CranStrawG7, ymax_CranStrawG7), 
                  xlim = c(ymin_CranStrawG7, ymax_CranStrawG7)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(22, 24)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
  theme_LO_sober
 CranStraw_G7

 
# Limits
ymin_StrawCheG7=min(min(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_StrawCheG7=max(max(TEMP_dataG7_StrawChe$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG7+0.99*(ymax_StrawCheG7-ymin_StrawCheG7)


StrawChe_G7 <-  ggplot(data = TEMP_dataG7_StrawChe) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_symp,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, 
                     xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logchange_symp, y = logchange_allop,  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.13, y = lim_text, label = eq_r(gen = 7, pair = "Strawberry_Cherry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(21, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  coord_cartesian(ylim = c(ymin_StrawCheG7, ymax_StrawCheG7), 
                  xlim = c(ymin_StrawCheG7, ymax_StrawCheG7)) + 
  theme_LO_sober
 StrawChe_G7
 
 
  
#####################################################################################
##################################      G29        ##################################
#####################################################################################
TEMP_dataG29_CheCran
TEMP_dataG29_CranStraw
TEMP_dataG29_StrawChe


# Limits
ymin_CheCranG29=min(min(TEMP_dataG29_CheCran$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CheCran$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CheCranG29=max(max(TEMP_dataG29_CheCran$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CheCran$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CheCranG29+0.99*(ymax_CheCranG29-ymin_CheCranG29)


CheCran_G29 <- ggplot(data = TEMP_dataG29_CheCran) + 
    geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = 0.33, y = lim_text, label = eq_r(gen = 29, pair = "Cherry_Cranberry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG29, ymax_CheCranG29), 
                  xlim = c(ymin_CheCranG29, ymax_CheCranG29)) + 
  theme_LO_sober
 CheCran_G29



# Limits
ymin_CranStrawG29=min(min(TEMP_dataG29_CranStraw$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CranStraw$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CranStrawG29=max(max(TEMP_dataG29_CranStraw$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CranStraw$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG29+0.99*(ymax_CranStrawG29-ymin_CranStrawG29)

#Plot
 CranStraw_G29 <- ggplot(data = TEMP_dataG29_CranStraw) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
   geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
   geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp,
                      xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
   geom_point(aes(x =logchange_symp, y = logchange_allop,  
                  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
   geom_text(x = -0.45, y = lim_text, label = eq_r(gen = 29, pair = "Cranberry_Strawberry"), parse = TRUE, color="black", size = 3.5) +
   xlab("Fitness change in\nselective environment")  + 
   ylab("Fitness change in\nalternative environment")  + 
   ggtitle("Cranberry vs. Strawberry") + 
   coord_cartesian(ylim = c(ymin_CranStrawG29, ymax_CranStrawG29), 
                  xlim = c(ymin_CranStrawG29, ymax_CranStrawG29)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(15, 17)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
   theme_LO_sober
 CranStraw_G29

 
 
 
# Limits
ymin_StrawCheG29=min(min(TEMP_dataG29_StrawChe$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_StrawCheG29=max(max(TEMP_dataG29_StrawChe$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_StrawChe$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG29+0.99*(ymax_StrawCheG29-ymin_StrawCheG29)


StrawChe_G29 <- ggplot(data = TEMP_dataG29_StrawChe) + 
 geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.2, y = lim_text, 
            label = eq_r(gen = 29, pair = "Strawberry_Cherry"), 
            parse = TRUE, color="black", size = 3.5) +
  coord_cartesian(ylim = c(ymin_StrawCheG29, ymax_StrawCheG29), 
                  xlim = c(ymin_StrawCheG29, ymax_StrawCheG29)) + 
    xlab("Fitness change in\nselective environment")  + 
    ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  theme_LO_sober
 StrawChe_G29





 
 
legend_tradevide <-  ggplot(data = data_logchange[data_logchange$Generation == "29",],
                          aes(x =logchange, y = logchange,  color = Fruit_s, fill = Fruit_s, 
                              shape = Treatment)) + 
  geom_point(size =2.5, fill = "white") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober

legend_trade <- lemon::g_legend(legend_tradevide)

 
 

Slopeestimates_logchange_pairwise_errorbar <- cowplot::ggdraw() + 
  cowplot::draw_plot(CheCran_G7 + theme(legend.position = "none"), 
            x = 0.01, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G7 + theme(legend.position = "none"), 
            x = 0.31, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G7 + theme(legend.position = "none"), 
            x = 0.61, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(legend_trade, x = 0.85, y = 0.5, width = 0.1, height = 0.1) + 
  cowplot::draw_plot(CheCran_G29 + theme(legend.position = "none"), 
            x = 0.01, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G29 + theme(legend.position = "none"), 
            x = 0.31, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G29 + theme(legend.position = "none"), 
            x = 0.61, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", "B", "C", " ",
                    "Final phenotyping step", "D", "E", "F", " "),  
                  x = c(0.30, 0.01, 0.30, 0.61, 0.92, 0.250, 0.01, 0.30, 0.61, 0.92), 
                  y = c(0.99, 0.95, 0.95, 0.95, 0.95, 0.49, 0.45, 0.45, 0.45, 0.45), 
                  hjust = c(-0.25, -0.25, -0.25, -0.25, -0.25, -0.75, -0.75, -0.75, -0.75, -0.75), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 Slopeestimates_logchange_pairwise_errorbar
#  
# #  
# 
cowplot::save_plot(file =here::here("figures", "FIG_Correlation.pdf"),
                   Slopeestimates_logchange_pairwise_errorbar,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)




```




## Plot SUP 
```{r } 
#Formating data


#Formatting for testing correlation
TEMP_dataG7_CheCran <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                           fruitcomb=c("Cherry", "Cranberry"), trait="fecundity")
TEMP_dataG7_CranStraw_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                                       fruitcomb=c("Strawberry", "Cranberry"), trait="fecundity")
TEMP_dataG7_StrawChe <- formattinglogchange(logchange_dataset = data_logchange, generation="7", 
                                            fruitcomb=c("Cherry", "Strawberry"), trait="fecundity")

TEMP_dataG29_CheCran_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                                      fruitcomb=c("Cherry", "Cranberry"), trait="fecundity")
TEMP_dataG29_CranStraw_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                                        fruitcomb=c("Strawberry", "Cranberry"), trait="fecundity")
TEMP_dataG29_StrawChe_Fecundity <- formattinglogchange(logchange_dataset = data_logchange, generation="29", 
                                                       fruitcomb=c("Cherry", "Strawberry"), trait="fecundity")




ymin = -50
ymax = 50



##################################################
##################   G7
# Limits
ymin_CheCranG7=min(min(TEMP_dataG7_CheCran$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CheCran$lowCIlogfitnesschange_symp, na.rm= TRUE)) 
ymax_CheCranG7=max(max(TEMP_dataG7_CheCran$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CheCran$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-2



# Plot
CheCran_G7 <- ggplot(data = TEMP_dataG7_CheCran) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_text(x = 0, y = 2, 
            label = eq_r(gen = 7, pair = "Cherry_Cranberry"), parse = TRUE, 
            color="black", size = 3.5) +
  geom_errorbar(aes(x = logchange_symp, ymin = lowCIlogfitnesschange_allop,
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                     color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logchange_symp, y = logchange_allop,  
                 color = Fruit_s,fill = Fruit_s, shape = Treatment),
             size = 3, fill = "white", stroke =1.2) + 
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  theme_LO_sober + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(21, 22)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG7, ymax_CheCranG7), 
                  xlim = c(ymin_CheCranG7, ymax_CheCranG7)) 
  
 CheCran_G7


# Limits
ymin_CranStrawG7=min(min(TEMP_dataG7_CranStraw$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_CranStraw$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CranStrawG7=max(max(TEMP_dataG7_CranStraw$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_CranStraw$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG7+0.99*(ymax_CranStrawG7-ymin_CranStrawG7)


CranStraw_G7 <-  ggplot(data = TEMP_dataG7_CranStraw) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x = logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_allop, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  color = Fruit_s,
                 fill = Fruit_s, shape = Treatment),
                   size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.25, y = lim_text, label = eq_r(gen = 7, pair = "Cranberry_Strawberry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
     ggtitle("Cranberry vs. Strawberry") + 
  coord_cartesian(ylim = c(ymin_CranStrawG7, ymax_CranStrawG7), 
                  xlim = c(ymin_CranStrawG7, ymax_CranStrawG7)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(22, 24)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
  theme_LO_sober
 CranStraw_G7

 
# Limits
ymin_StrawCheG7=min(min(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_StrawCheG7=max(max(TEMP_dataG7_StrawChe$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG7_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG7+0.99*(ymax_StrawCheG7-ymin_StrawCheG7)


StrawChe_G7 <-  ggplot(data = TEMP_dataG7_StrawChe) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation == 7 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_symp,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, 
                     xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x = logchange_symp, y = logchange_allop,  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.13, y = lim_text, label = eq_r(gen = 7, pair = "Strawberry_Cherry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(21, 24)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  coord_cartesian(ylim = c(ymin_StrawCheG7, ymax_StrawCheG7), 
                  xlim = c(ymin_StrawCheG7, ymax_StrawCheG7)) + 
  theme_LO_sober
 StrawChe_G7
 
 
  
#####################################################################################
##################################      G29        ##################################
#####################################################################################
TEMP_dataG29_CheCran
TEMP_dataG29_CranStraw
TEMP_dataG29_StrawChe


# Limits
ymin_CheCranG29=min(min(TEMP_dataG29_CheCran$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CheCran$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CheCranG29=max(max(TEMP_dataG29_CheCran$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CheCran$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CheCranG29+0.99*(ymax_CheCranG29-ymin_CheCranG29)


CheCran_G29 <- ggplot(data = TEMP_dataG29_CheCran) + 
    geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cherry_Cranberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = 0.33, y = lim_text, label = eq_r(gen = 29, pair = "Cherry_Cranberry"), parse = TRUE, color="black", size = 3.5) +
  xlab("Fitness change in\nselective environment")  + 
  ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Cherry vs. Cranberry") + 
  labs(shape = "Test fruit", color = "Evolution fruit") + 
  scale_shape_manual(values = c(16, 15)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424"))  + 
  coord_cartesian(ylim = c(ymin_CheCranG29, ymax_CheCranG29), 
                  xlim = c(ymin_CheCranG29, ymax_CheCranG29)) + 
  theme_LO_sober
 CheCran_G29



# Limits
ymin_CranStrawG29=min(min(TEMP_dataG29_CranStraw$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_CranStraw$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_CranStrawG29=max(max(TEMP_dataG29_CranStraw$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_CranStraw$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_CranStrawG29+0.99*(ymax_CranStrawG29-ymin_CranStrawG29)

#Plot
 CranStraw_G29 <- ggplot(data = TEMP_dataG29_CranStraw) + 
  geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Cranberry_Strawberry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
   geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.3, alpha = 0.8) + 
   geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp,
                      xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.3, alpha = 0.8) + 
   geom_point(aes(x =logchange_symp, y = logchange_allop,  
                  color = Fruit_s,fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
   geom_text(x = -0.45, y = lim_text, label = eq_r(gen = 29, pair = "Cranberry_Strawberry"), parse = TRUE, color="black", size = 3.5) +
   xlab("Fitness change in\nselective environment")  + 
   ylab("Fitness change in\nalternative environment")  + 
   ggtitle("Cranberry vs. Strawberry") + 
   coord_cartesian(ylim = c(ymin_CranStrawG29, ymax_CranStrawG29), 
                  xlim = c(ymin_CranStrawG29, ymax_CranStrawG29)) + 
   labs(shape = "Test fruit", color = "Selection fruit") + 
   scale_shape_manual(values = c(15, 17)) + 
   scale_color_manual(values = c("#FDB424", "#3FAA96"))  + 
   theme_LO_sober
 CranStraw_G29

 
 
 
# Limits
ymin_StrawCheG29=min(min(TEMP_dataG29_StrawChe$lowCIlogfitnesschange_allop, na.rm= TRUE),
                min(TEMP_dataG29_StrawChe$lowCIlogfitnesschange_symp, na.rm= TRUE))
ymax_StrawCheG29=max(max(TEMP_dataG29_StrawChe$upCIlogfitnesschange_allop, na.rm= TRUE),
                max(TEMP_dataG29_StrawChe$upCIlogfitnesschange_symp, na.rm= TRUE))
lim_text<-ymin_StrawCheG29+0.99*(ymax_StrawCheG29-ymin_StrawCheG29)


StrawChe_G29 <- ggplot(data = TEMP_dataG29_StrawChe) + 
 geom_abline(intercept = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "intercept"],
               slope = Estimates_pairwise$Estimates[Estimates_pairwise$Generation ==29 & 
                               Estimates_pairwise$Pairwise == "Strawberry_Cherry" & 
                               Estimates_pairwise$Variables == "slope"],
              colour = "black", size = 0.75) + 
  geom_errorbar(aes(x =logchange_symp, ymin = lowCIlogfitnesschange_allop, 
                    ymax = upCIlogfitnesschange_allop,
                    color = Fruit_s),
                  width= 0.02, size = 0.2, alpha =1) + 
  geom_errorbarh(aes(y = logchange_allop, xmin = lowCIlogfitnesschange_symp, 
                     xmax = upCIlogfitnesschange_symp, 
                 color = Fruit_s),
                 height = 0.02, size = 0.2, alpha =1) + 
  geom_point(aes(x =logchange_symp, y = logchange_allop,  
                 color = Fruit_s, fill = Fruit_s, shape = Treatment),
                 size =3, fill = "white", stroke =1.2) + 
  geom_text(x = -0.2, y = lim_text, 
            label = eq_r(gen = 29, pair = "Strawberry_Cherry"), 
            parse = TRUE, color="black", size = 3.5) +
  coord_cartesian(ylim = c(ymin_StrawCheG29, ymax_StrawCheG29), 
                  xlim = c(ymin_StrawCheG29, ymax_StrawCheG29)) + 
    xlab("Fitness change in\nselective environment")  + 
    ylab("Fitness change in\nalternative environment")  + 
  ggtitle("Strawberry vs. Cherry") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#3FAA96"))  + 
  theme_LO_sober
 StrawChe_G29





 
 
legend_tradevide <-  ggplot(data = data_logchange[data_logchange$Generation == "29",],
                          aes(x =logchange, y = logchange,  color = Fruit_s, fill = Fruit_s, 
                              shape = Treatment)) + 
  geom_point(size =2.5, fill = "white") + 
  labs(shape = "Test fruit", color = "Selection fruit") + 
  scale_shape_manual(values = c(16, 15, 17)) + 
  scale_color_manual(values = c("#BC3C6D", "#FDB424", "#3FAA96"))  + 
  theme_LO_sober

legend_trade <- lemon::g_legend(legend_tradevide)

 
 

Slopeestimates_logchange_pairwise_errorbar <- cowplot::ggdraw() + 
  cowplot::draw_plot(CheCran_G7 + theme(legend.position = "none"), 
            x = 0.01, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G7 + theme(legend.position = "none"), 
            x = 0.31, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G7 + theme(legend.position = "none"), 
            x = 0.61, y = 0.5, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(legend_trade, x = 0.85, y = 0.5, width = 0.1, height = 0.1) + 
  cowplot::draw_plot(CheCran_G29 + theme(legend.position = "none"), 
            x = 0.01, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(CranStraw_G29 + theme(legend.position = "none"), 
            x = 0.31, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot(StrawChe_G29 + theme(legend.position = "none"), 
            x = 0.61, y = 0, width = 0.22, height = 0.45) + 
  cowplot::draw_plot_label(c("Intermediate phenotyping step", "A", "B", "C", " ",
                    "Final phenotyping step", "D", "E", "F", " "),  
                  x = c(0.30, 0.01, 0.30, 0.61, 0.92, 0.250, 0.01, 0.30, 0.61, 0.92), 
                  y = c(0.99, 0.95, 0.95, 0.95, 0.95, 0.49, 0.45, 0.45, 0.45, 0.45), 
                  hjust = c(-0.25, -0.25, -0.25, -0.25, -0.25, -0.75, -0.75, -0.75, -0.75, -0.75), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 Slopeestimates_logchange_pairwise_errorbar
#  
# #  
# 
cowplot::save_plot(file =here::here("figures", "FIG_Correlation.pdf"),
                   Slopeestimates_logchange_pairwise_errorbar,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)




```


# SA AND LOCAL ADAPTATION
## Analysis fitness change
```{r }
##### 
#####  G7
##### 
lm_val_G7 = lm(logchange ~ Treatment + Line + SA + Treatment:Fruit_s, 
               weights = N, data = data_logchange[data_logchange$Generation=="7",])

Fratio = anova(lm_val_G7)[3, 3]/anova(lm_val_G7)[4, 3]
pvalue = 1 - pf(Fratio, anova(lm_val_G7)[3, 1], anova(lm_val_G7)[4, 1]) 

pvalue
Fratio
anova(lm_val_G7)[3, 1]
anova(lm_val_G7)[4, 1]

##### 
#####  G29
##### 
lm_val_G29 = lm(logchange ~ Treatment + Line + SA + Treatment:Fruit_s, 
               weights = N, data = data_logchange[data_logchange$Generation=="29",])

Fratio = anova(lm_val_G29)[3, 3]/anova(lm_val_G29)[4, 3]
pvalue = 1 - pf(Fratio, anova(lm_val_G29)[3, 1], anova(lm_val_G29)[4, 1]) 

pvalue
Fratio
anova(lm_val_G29)[3, 1]
anova(lm_val_G29)[4, 1]


```
