---
title: "Simulation of log fitness change"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
library("ggplot2")
library("cowplot")
library("Rmisc")
library("lme4")

theme_LO_sobre <- theme(plot.title = element_text( size=12,face="bold",hjust = 0.5),
        axis.title.x = element_text( size=10),
        axis.title.y = element_text( size=10),
        axis.text.x  = element_text( size=8), 
        axis.text.y  =  element_text( size=8),
        panel.background = element_rect(fill = "white",colour = "white",size = 0.5, linetype = "solid"),
        panel.grid.major.y = element_line(size = 0.025, linetype = 'solid',colour = "grey"), 
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x= element_blank(),
        panel.grid.minor.x= element_blank(),
        axis.line = element_line(colour = "grey30", size = 0.4, linetype = "solid"))
pd <- position_dodge(0.3) # move them .05 to the left and right
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```

# Import data
```{r }
## Initial phenotyping
data_G0 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G1")

## Intemediate phenotyping
data_G7 <- loadfitnessdata(dataset = "Selection_Phenotypage_G0_G7_G8.csv", generation = "G7")

## Final phenotyping
data_G29 <- loadfitnessdata(dataset = "PERFORMANCE_Comptage_adultes_G13G14G15G16G17G18G19G20G21G22G23G24G25G26G27G28G29.csv", generation = "29")

head(data_G0)
head(data_G7)
head(data_G29)





```

# Adaptation analysis
## Prepare data
```{r }

data_total_dyn<-read.table("/Users/laure/Dropbox/TEMP_Discussion_Nico_Evolexp/Data/DATA_Adults_G1G29.csv",sep=";",header=T)


data_fitness_all<-data_total_dyn[data_total_dyn$Treatment=="Cherry"|
                           data_total_dyn$Treatment=="Cranberry"|
                           data_total_dyn$Treatment=="Strawberry",]
data_fitness_all$obs<-as.factor(1:nrow(data_fitness_all))
data_fitness_all<-droplevels(data_fitness_all)


#Remove generation with parental development on GF : G1 G7 and G29
TEMP_data_fitness_all<-data_fitness_all[data_fitness_all$Generation!=1&data_fitness_all$Generation!=7&data_fitness_all$Generation!=29,]


head(TEMP_data_fitness_all)

######  1- Extract mean for each lines and each generations + se + N (number of tubes)
data_all_sum<-Rmisc::summarySE(TEMP_data_fitness_all,
          measurevar="Nb_adults",
          groupvars=c("Lines","Fruit_s","Generation","Step","T_counted"), na.rm=TRUE)

#Replace the N (=Number of tubes used to estimate the mean) for pool step (rplace NA by T_counted)
data_all_sum[data_all_sum$Step=="pool",]$N<-data_all_sum[data_all_sum$Step=="pool",]$T_counted

#Remove useless columns 
data_sum<-subset(data_all_sum, select = -c(T_counted,ci))

###### 2- Tranform to fitness (log(mean/20))
data_sum$fitness<-log(data_sum$Nb_adults/20)

###### 3- Calcul se for fitness (sqrt(sd/N*mean))
#With Hedges et al. 1999
#logchange=Ln(x1/x2) with x1 and the x2 the mean of Nt+1 and Nt respectively
#logchange=ln((meanNt+1)/20)
#se(logchange)=sqrt((s1²/n1x1²)+(s2²/n2x2²)) with s1 and s2 the standard deviation of Nt+1 and Nt respesctively, and n1 and n2 the sample size of  Nt+1 and Nt respesctively
#In our case: x2=20 and s2=0 
#So: se(logchange)=sqrt((s1²/n1x1²))=sqrt((sdNt+1²)/(NNt+1*meanNt+1²))

data_sum$se_fitness<-sqrt((data_sum$sd^2)/(data_sum$N*(data_sum$Nb_adults^2)))

#Check with se: 
data_sum$se_fitness_verif<-sqrt((data_sum$se^2)/(data_sum$Nb_adults^2))

#Remove useless columns 
data_sum<-subset(data_sum, select = -c(se, se_fitness_verif))


head(data_sum)
tail(data_sum)
str(data_sum)


###### 4-Create three subset
data_fitness_cherry<-data_sum[data_sum$Fruit_s=="Cherry",]
data_fitness_cranb<-data_sum[data_sum$Fruit_s=="Cranberry",]
data_fitness_straw<-data_sum[data_sum$Fruit_s=="Strawberry",]


```


## Models
```{r }
######## FORWARD MODEL SELECTION 
mod_nul<-lme4::lmer(fitness ~ 1 + (1|Generation), 
            weights = N, data = data_sum)


mod_Fruits<-lme4::lmer(fitness ~ Fruit_s + (1|Generation), 
            weights = N, data = data_sum)

mod_Generation<-lme4::lmer(fitness ~ Generation + (1|Generation), 
            weights = N, data = data_sum)

mod_Step<-lme4::lmer(fitness~ Step + (1|Generation), 
            weights = N, data = data_sum)

mod_Lines<-lme4::lmer(fitness~ Lines + (1|Generation), 
            weights = N, data = data_sum)

mod_Generation_Step<-lme4::lmer(fitness~ Step + Generation + (1|Generation) , 
            weights = N, data = data_sum)

mod_Generation_Fruits<-lme4::lmer(fitness ~ Generation + Fruit_s + (1|Generation), 
            weights = N, data = data_sum)

mod_Fruits_Step<-lme4::lmer(fitness ~ Step + Fruit_s + (1|Generation), 
            weights = N, data = data_sum)


mod_Generation_Fruits_Step<-lme4::lmer(fitness ~ Generation + Step + Fruit_s +(1|Generation), 
                              weights = N, data = data_sum)


mod_Doubleinteraction<-lme4::lmer(fitness ~ Generation + Step + Fruit_s +
                              Fruit_s:Generation +
                              (1|Generation) , 
                              weights = N, data = data_sum)


mod_Double<-lme4::lmer(fitness ~ Step*Fruit_s +
                              (1|Generation), 
                              weights = N, data = data_sum)

mod_Double_Generation<-lme4::lmer(fitness ~ Generation+Step*Fruit_s +
                              (1|Generation), 
                              weights = N, data = data_sum)

mod_Tripleinteraction<-lme4::lmer(fitness ~ Generation*Step*Fruit_s +
                              (1|Generation), 
                              weights = N, data = data_sum)

mod_DoublePopulationGeneration<-lme4::lmer(fitness ~ Generation*Lines +
                              (1|Generation), 
                              weights = N, data = data_sum)

#Test AICC
AICc(mod_nul,mod_Fruits,mod_Generation,mod_Step,mod_Lines,mod_Generation_Step,mod_Generation_Fruits,mod_Fruits_Step,mod_Generation_Fruits_Step,mod_Doubleinteraction,mod_Double,mod_Double_Generation,mod_Tripleinteraction,mod_DoublePopulationGeneration)

anova(mod_nul,mod_Fruits,mod_Generation,mod_Step,mod_Lines,mod_Generation_Step,mod_Generation_Fruits,mod_Fruits_Step,mod_Generation_Fruits_Step,mod_Doubleinteraction,mod_Double,mod_Double_Generation,mod_Tripleinteraction,mod_DoublePopulationGeneration)

summary(mod_Fruits_Step)



#Posthoc
mod_Best<-lmer(fitness~ Step -1+ Fruit_s+ (1|Generation), 
            weights = N, data = data_sum)
emmeans(mod_Best, list(pairwise ~ Step:Fruit_s), adjust = "tukey") #

emmeans(mod_Best, list(pairwise ~ Fruit_s), adjust = "tukey") #
emmeans(mod_Best, list(pairwise ~ Step), adjust = "tukey") #

summary(mod_Best)




```







## Plot 
```{r }
#Extract slope and intercept
dat_predict_allfruits <- expand.grid(Generation=as.numeric(levels(as.factor(data_sum$Generation))),
                                     Fruit_s=unique(data_sum$Fruit_s))
dat_predict_allfruits$Step<-ifelse(dat_predict_allfruits$Generation<=7,"first_prepool",ifelse(dat_predict_allfruits$Generation>=12,"second_postpool","pool"))

dat_predict_allfruits$fitness_predicted<-predict(mod_Best, newdata = dat_predict_allfruits, 
                          re.form=NA, type="response")

#REAL DATA
#Add G1 G6 and G7
TEMP_lineG1<-c(rep(NA,2),1,rep(NA,5))
TEMP_lineG6<-c(rep(NA,2),6,rep(NA,5))
TEMP_lineG7<-c(rep(NA,2),7,rep(NA,5))

TEMP_total<-rbind(data_sum,TEMP_lineG1,TEMP_lineG1,TEMP_lineG1,TEMP_lineG6,TEMP_lineG6,TEMP_lineG6,TEMP_lineG7,TEMP_lineG7,TEMP_lineG7)
TEMP_total$Fruit_s[TEMP_total$Generation=="6"]<-c("Strawberry","Cranberry","Cherry")
TEMP_total$Fruit_s[TEMP_total$Generation=="1"]<-c("Strawberry","Cranberry","Cherry")
TEMP_total$Fruit_s[TEMP_total$Generation=="7"]<-c("Strawberry","Cranberry","Cherry")
tail(TEMP_total)


## Add label 
TEMP_anno <- data.frame(x1 = c(3.5,3.5,10,3.5,3.5,10,3.5,3.5,10), x2 = c(9,17.5,17.5,9,17.5,17.5,9,17.5,17.5),
                   y1 = c(1,2,1.2,1,2,1.2,1,2,1.2), y2 = c(1.25,2.25,1.45,1.25,2.25,1.45,1.25,2.25,1.45),
                   xstar = c(6.5,10,14,6.5,10,14,6.5,10,14), ystar = c(1.5,2.5,1.7,1.5,2.5,1.7,1.5,2.5,1.7),
                   lab = c("**", "***", "***" ,"**", "***", "***" , "**", "***", "***" ),
                   Fruit_s = c("Cherry", "Cherry", "Cherry",
                               "Cranberry", "Cranberry", "Cranberry",
                               "Strawberry","Strawberry","Strawberry"), 
                   Lines=NA)
TEMP_anno


TEMP_title<-data.frame(xtitle=c(14,14,14),
                       ytitle=c(3,3,3),
                       title=c("Cherry","Cranberry","Strawberry"),
                       Fruit_s=c("Cherry","Cranberry","Strawberry"), 
                       Lines=NA)
TEMP_title




PLOT_FITNESS_CHERRY<-ggplot2::ggplot(data=TEMP_total[TEMP_total$Fruit_s=="Cherry",], 
                            aes(x=factor(Generation),group=Lines, y=fitness, colour=Fruit_s)) + 
  geom_errorbar(aes(ymin=fitness-1.96*se_fitness, ymax=fitness+1.96*se_fitness),
                width=.1,position=pd,size=0.2,color="black") +
  geom_line(size=0.3,position=pd) +
  geom_line(data=dat_predict_allfruits[dat_predict_allfruits$Fruit_s=="Cherry",], aes(x=factor(Generation), y=fitness_predicted, colour="black", group = Step),
                size=0.5) +
  geom_point(size=1, position=pd,shape=21, fill="white") +
  ylim(-3,3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s=="Cherry",], aes(x = xstar,  y = ystar, label = lab),size=3.3) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cherry",], aes(x = x1, xend = x1, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cherry",], aes(x = x2, xend = x2, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cherry",], aes(x = x1, xend = x2, 
           y = y2, yend = y2),size=0.4) + 
  scale_color_manual(values=c("black","#BC3C6D", "#FDB424", "#3FAA96")) +  
  ggtitle("Cherry") +
  theme_LO_sobre +
    theme(panel.grid.major.y = element_line(size = 0.1, linetype = 'solid',colour = "grey"),
        panel.grid.minor.y = element_line(size = 0.05, linetype = 'solid',colour = "grey"),
        strip.background = element_rect(fill="white"),
        axis.text.x  = element_text( size=6), 
        legend.position='none',
        strip.text.x = element_text(size=4, color="transparent"), 
        plot.title = element_text( size=10,face="bold",hjust = 0.5, color="#BC3C6D"))
PLOT_FITNESS_CHERRY



PLOT_FITNESS_CRANB<-ggplot2::ggplot(data=TEMP_total[TEMP_total$Fruit_s=="Cranberry",], 
                            aes(x=factor(Generation),group=Lines, y=fitness, colour=Fruit_s)) + 
  geom_errorbar(aes(ymin=fitness-1.96*se_fitness, ymax=fitness+1.96*se_fitness),
                width=.1,position=pd,size=0.2,color="black") +
  geom_line(size=0.3,position=pd) +
  geom_line(data=dat_predict_allfruits[dat_predict_allfruits$Fruit_s=="Cranberry",], aes(x=factor(Generation), y=fitness_predicted, colour="black", group = Step),
                size=0.5) +
  geom_point(size=1, position=pd,shape=21, fill="white") +
  ylim(-3,3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s=="Cranberry",], aes(x = xstar,  y = ystar, label = lab),size=3.3) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cranberry",], aes(x = x1, xend = x1, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cranberry",], aes(x = x2, xend = x2, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Cranberry",], aes(x = x1, xend = x2, 
           y = y2, yend = y2),size=0.4) + 
  scale_color_manual(values=c("black", "#FDB424")) +  
  ggtitle("Cranberry") +
  theme_LO_sobre +
    theme(panel.grid.major.y = element_line(size = 0.1, linetype = 'solid',colour = "grey"),
        panel.grid.minor.y = element_line(size = 0.05, linetype = 'solid',colour = "grey"),
                axis.text.x  = element_text( size=6), 
        strip.background = element_rect(fill="white"),
        legend.position='none',
        strip.text.x = element_text(size=4, color="transparent"), 
        plot.title = element_text( size=10,face="bold",hjust = 0.5, color="#FDB424"))
PLOT_FITNESS_CRANB



PLOT_FITNESS_STRAW<-ggplot2::ggplot(data=TEMP_total[TEMP_total$Fruit_s=="Strawberry",], 
                            aes(x=factor(Generation),group=Lines, y=fitness, colour=Fruit_s)) + 
  geom_errorbar(aes(ymin=fitness-1.96*se_fitness, ymax=fitness+1.96*se_fitness),
                width=.1,position=pd,size=0.2,color="black") +
  geom_line(size=0.3,position=pd) +
  geom_line(data=dat_predict_allfruits[dat_predict_allfruits$Fruit_s=="Strawberry",], aes(x=factor(Generation), y=fitness_predicted, colour="black", group = Step),
                size=0.5) +
  geom_point(size=1, position=pd,shape=21, fill="white") +
  ylim(-3,3.05) + 
  ylab("Fitness") + 
  xlab("Generation") + 
  geom_text(data = TEMP_anno[TEMP_anno$Fruit_s=="Strawberry",], aes(x = xstar,  y = ystar, label = lab),size=3.3) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Strawberry",], aes(x = x1, xend = x1, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Strawberry",], aes(x = x2, xend = x2, 
           y = y1, yend = y2),size=0.4) +
  geom_segment(data = TEMP_anno[TEMP_anno$Fruit_s=="Strawberry",], aes(x = x1, xend = x2, 
           y = y2, yend = y2),size=0.4) + 
  scale_color_manual(values=c("black", "#3FAA96")) +  
  ggtitle("Strawberry") +
  theme_LO_sobre +
    theme(panel.grid.major.y = element_line(size = 0.1, linetype = 'solid',colour = "grey"),
        panel.grid.minor.y = element_line(size = 0.05, linetype = 'solid',colour = "grey"),
        strip.background = element_rect(fill="white"),
                axis.text.x  = element_text( size=6), 
        legend.position='none',
        strip.text.x = element_text(size=4, color="transparent"), 
        plot.title = element_text( size=10,face="bold",hjust = 0.5, color="#3FAA96"))
PLOT_FITNESS_STRAW




DYNAMIQUE_THREE_JOIN <- cowplot::ggdraw() +
  draw_plot(PLOT_FITNESS_CHERRY+theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.line.x = element_blank()), 
            x =0, y = 0.66, width = 1, height = 0.33) +
  draw_plot(PLOT_FITNESS_CRANB+theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.line.x = element_blank()), 
            x = 0, y = 0.33, width = 1, height = 0.33) +
  draw_plot(PLOT_FITNESS_STRAW, 
            x = 0, y = 00, width = 1, height = 0.33) + 
  draw_plot_label(c("A", "B", "C"),  
                  x = c(0,0,0), 
                  y = c(1,0.66,0.33), 
                  hjust = c(-0.5,-0.5,-0.5), 
                  vjust = c(1.5,1.5,1.5),
                  size = 12) 
 DYNAMIQUE_THREE_JOIN


cowplot::save_plot("figures/Fitness_evolexp_Model_Pop.pdf", DYNAMIQUE_THREE_JOIN, base_height = 17/cm(1), base_width = 11/cm(1), dpi = 1200)
# 


```



